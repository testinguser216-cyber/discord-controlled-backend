You're asking for a complete overhaul of your frontend JavaScript within your `index.html` to integrate with the backend. This is a very substantial request, as it means replacing almost all data management (which was previously `localStorage` and direct webhooks) with calls to your new backend API.

Given that you want to continue with the "all web, no terminal" approach, I will provide the **complete, modified `index.html` file**.

**Key Changes I'm making:**

1.  **`API_BASE_URL` Constant:** Added at the top of the main script, you **MUST REPLACE THE PLACEHOLDER** with your Vercel backend's URL.
2.  **`api` Object:** A new JavaScript object (`window.api`) is created directly within the script to handle all backend API calls using `fetch`. This simulates the `api.js` file but keeps everything in one HTML file.
3.  **Authentication:**
    *   `login()` calls `api.login()`.
    *   A successful login stores the `token` and user data (ID, name, role, settings, stats, click\_count) in `sessionStorage`.
    *   Subsequent API calls use this token.
4.  **`localStorage` Removal:** All `localStorage.getItem()`, `localStorage.setItem()` calls are replaced with `api` calls.
5.  **Direct Webhook Removal:** All `sendWebhook()` calls are removed. The frontend will now call a backend logging endpoint (`api.logLoginAttempt`, `api.logActivity`, `api.logError`), and your backend will be responsible for sending the Discord webhooks securely.
6.  **`whitelist` and `RESET_CODE_SECRET` Removal:** These are now handled by the backend.
7.  **Dynamic UI Population:** Many panels (Login History, Important Dates, Stats, etc.) will now fetch their data from the backend when the dashboard initializes or when their respective panel is opened, rather than loading from local storage.
8.  **Placeholder Backend Data:** For most elements (e.g., random facts, quotes, system updates, wifi info, all static modals), the frontend will initially try to fetch this data from the backend. Since you haven't built those backend endpoints yet, they will likely return "Coming Soon" or empty arrays. We'll build these backend endpoints later.

**Before you deploy this modified `index.html`:**

1.  **YOUR BACKEND API MUST BE DEPLOYED AND RUNNING ON VERCEL.**
2.  **YOU MUST HAVE YOUR `API_BASE_URL`:** This is your Vercel backend URL, typically ending in `/api` (e.g., `https://discord-controlled-backend-xxxx.vercel.app/api`).
3.  **YOU MUST HAVE AN ADMIN USER REGISTERED IN YOUR BACKEND DATABASE.** (You did this using Hoppscotch/Postman in the previous step).

---

Here is the **complete modified `index.html`**. This is extremely long, so I recommend opening it in a proper text editor or the GitHub online editor.

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Private System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap');
    
    :root {
      --primary-bg: #0a0a0a;
      --secondary-bg: #1a1a1a;
      --accent-color: #ff4500;
      --accent-secondary: #ff6b35;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --border-color: #333;
      --success-color: #00ff41;
      --warning-color: #ffaa00;
      --error-color: #ff0040;
    }

    /* Light Theme Variables */
    body.light-theme {
      --primary-bg: #f0f2f5;
      --secondary-bg: #ffffff;
      --accent-color: #007bff; /* Using a blue accent for light mode as an example */
      --accent-secondary: #0056b3;
      --text-primary: #333333;
      --text-secondary: #666666;
      --border-color: #e0e0e0;
      --success-color: #28a745; /* Green for light theme success */
      --warning-color: #ffc107; /* Yellow for light theme warning */
      --error-color: #dc3545;   /* Red for light theme error */
    }

    /* Adjust specific elements for light theme */
    body.light-theme .login-box {
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid var(--accent-color);
      box-shadow: 0 0 30px rgba(0, 123, 255, 0.3);
    }
    body.light-theme .login-box h2 {
      background: linear-gradient(45deg, var(--accent-color), #333);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    body.light-theme .login-box input {
      background: rgba(240, 240, 240, 0.8);
      border: 2px solid var(--border-color);
      color: #333;
    }
    body.light-theme .toggle-container span, body.light-theme .time-date-box .date-display {
      color: var(--text-primary);
    }
    body.light-theme .dashboard-header {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
      color: white; /* Keep header text white for contrast */
    }
    body.light-theme .quick-btn {
      background: var(--accent-color);
      color: white;
    }
    body.light-theme .quick-btn:hover {
      background: var(--accent-secondary);
    }
    body.light-theme .dashboard-quickbar {
        background: var(--secondary-bg);
        border-color: var(--border-color);
    }
    body.light-theme .search-bar {
      background: var(--primary-bg);
      border-color: var(--border-color);
      color: var(--text-primary);
    }
    body.light-theme .search-btn {
      background: var(--accent-color);
    }
    body.light-theme .search-btn:hover {
        background: var(--accent-secondary);
    }
    body.light-theme .quickbar-time-info {
        background-color: var(--primary-bg);
        border-color: var(--border-color);
        color: var(--text-primary);
    }
    body.light-theme .panels-grid {
      border: none;
    }
    body.light-theme .panel {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    body.light-theme .panel-title {
      color: var(--accent-color);
    }
    body.light-theme .panel-controls .panel-btn {
      background: var(--secondary-bg);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }
    body.light-theme .panel-controls .panel-btn:hover {
      background: var(--accent-color);
      color: white;
    }
    body.light-theme .calendar-cell {
      background: var(--primary-bg);
      color: var(--text-primary);
    }
    body.light-theme .calendar-cell:hover, body.light-theme .calendar-cell.today {
      background: var(--accent-color);
      color: white;
    }
    body.light-theme .log-entry {
      background: var(--primary-bg);
      border-left-color: var(--accent-color); /* Kept accent for log importance */
      color: var(--text-primary);
    }
    body.light-theme .log-time {
      color: var(--text-secondary);
    }
    body.light-theme .login-entry-container {
        background-color: var(--primary-bg);
    }
    body.light-theme .login-entry-container.success {
        border-left: 4px solid var(--success-color);
    }
    body.light-theme .login-entry-container.failed {
        border-left: 4px solid var(--error-color);
    }
    body.light-theme .error-log-entry.error { /* This rule is specific to .error class, adjusted below */
        border-left: 4px solid var(--error-color);
        background-color: var(--primary-bg);
        color: var(--text-primary);
    }

    /* Fixed styling for system update items to match theme */
    body.light-theme .system-update-item {
        background-color: var(--primary-bg); /* Match other list items */
        border-left: 4px solid var(--accent-secondary); /* Give it an accent */
        color: var(--text-primary);
    }

    body.light-theme .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--secondary-bg); /* Use theme background */
      border: 2px solid var(--success-color); /* Accent border to signify its status */
      color: var(--text-primary); /* Use theme text color */
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); /* Adjust shadow for both themes */
      z-index: 1000;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .panels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      transition: opacity 0.3s ease-in-out;
    }

    .panel {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      padding: 20px;
      position: relative;
      transition: all 0.3s ease;
      resize: both;
      overflow: auto;
      min-height: 200px;
    }

    .panel:hover {
      box-shadow: 0 5px 20px rgba(255, 69, 0, 0.2);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .panel-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-color);
    }

    .panel-controls {
      display: flex;
      gap: 5px;
    }

    .panel-btn {
      background: none;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      border-radius: 4px;
      width: 25px;
      height: 25px;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.3s ease;
    }

    .panel-btn:hover {
      background: var(--accent-color);
      color: white;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 15px;
    }

    .calendar-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-bg);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
    }

    .calendar-cell:hover {
      background: var(--accent-color);
    }

    .calendar-cell.today {
      background: var(--accent-color);
      color: white;
      font-weight: bold;
    }

    /* Login History Entries */
    .login-entry-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 6px;
        font-size: 12px;
        border: 1px solid var(--border-color);
        background-color: var(--primary-bg);
        transition: background-color 0.3s ease;
    }
    .login-entry-container.success {
        border-left: 4px solid var(--success-color);
        background-color: var(--primary-bg); /* Use primary for list item backgrounds */
    }
    .login-entry-container.failed {
        border-left: 4px solid var(--error-color);
        background-color: var(--primary-bg); /* Use primary for list item backgrounds */
    }
    .login-entry-status {
        font-weight: bold;
        color: var(--text-primary);
    }
    .login-entry-time {
        color: var(--text-secondary);
        font-size: 10px;
    }

    /* Important Dates styling */
    .important-date-input, .important-date-event-input {
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--primary-bg); /* Added background color */
        color: var(--text-primary);
        font-size: 14px;
        transition: border-color 0.3s ease;
    }
    .important-date-input:focus, .important-date-event-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }
    .important-date-item {
        padding: 8px 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        background-color: var(--primary-bg); /* Added background color */
        border-left: 4px solid var(--accent-secondary); /* Accent for visual interest */
        color: var(--text-primary);
        font-size: 13px;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .important-date-item .date-time {
        font-weight: bold;
        color: var(--accent-color);
    }
    .important-date-item .event-description {
        color: var(--text-secondary);
    }


    /* System Updates Panel Styling */
    .system-update-item {
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
        font-size: 12px;
        background-color: var(--primary-bg); /* Apply theme-adaptive background */
        border-left: 4px solid var(--accent-secondary); /* Give it a subtle accent border */
        color: var(--text-primary); /* Ensure text color adapts */
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }


    /* Settings Modal */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .settings-content {
      background: var(--secondary-bg);
      border: 2px solid var(--accent-color);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--primary-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    /* Drawing Tools */
    .drawing-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding: 15px;
      background: var(--primary-bg);
      border-radius: 10px;
    }

    .tool-btn {
      padding: 8px 12px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .tool-btn:hover, .tool-btn.active {
      background: var(--accent-secondary);
      transform: scale(1.05);
    }

    .color-picker {
      width: 30px;
      height: 30px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .thickness-slider {
      width: 100px;
      accent-color: var(--accent-color);
    }

    /* Timer/Stopwatch */
    .timer-display {
      font-family: 'Orbitron', monospace;
      font-size: 36px;
      font-weight: 700;
      color: var(--accent-color);
      text-align: center;
      margin: 20px 0;
    }

    .timer-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    /* Activity Logs */
    .log-entry {
      padding: 10px;
      background: var(--primary-bg);
      border-left: 4px solid var(--accent-color);
      margin-bottom: 10px;
      border-radius: 6px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
    }

    .log-time {
      color: var(--text-secondary);
      font-size: 10px;
    }

    /* Error Log Entries */
    .error-log-entry {
        padding: 10px;
        background: var(--primary-bg); /* Added background color */
        border-left: 44px solid var(--error-color);
        margin-bottom: 10px;
        border-radius: 6px;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        color: var(--text-primary);
    }
    .error-log-time {
        color: var(--text-secondary);
        font-size: 10px;
    }


    /* Stats Display */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      text-align: center;
      padding: 15px;
      background: var(--primary-bg);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .stat-number {
      font-family: 'Orbitron', monospace;
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Themes */
    .theme-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .theme-option {
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    .theme-option:hover, .theme-option.active {
      border-color: var(--accent-color);
      transform: scale(1.05);
    }

    /* Calculator */
    .calculator {
      background: var(--primary-bg);
      border-radius: 15px;
      padding: 20px;
      margin-top: 15px;
    }

    .calc-display {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      text-align: right;
      font-family: 'Orbitron', monospace;
      font-size: 24px;
      color: var(--accent-color);
      margin-bottom: 15px;
      min-height: 60px;
    }

    .calc-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .calc-btn {
      aspect-ratio: 1;
      border: none;
      border-radius: 8px;
      background: var(--secondary-bg);
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calc-btn:hover {
      background: var(--accent-color);
    }

    .calc-btn.operator {
      background: var(--accent-color);
    }

    .calc-btn.equals {
      background: var(--success-color);
      color: black;
    }

    /* Media Player */
    .media-container {
      background: var(--primary-bg);
      border-radius: 15px;
      padding: 20px;
      margin-top: 15px;
    }

    .media-input {
      width: 100%;
      padding: 10px;
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: white;
      margin-bottom: 15px;
    }

    .media-frame {
      width: 100%;
      height: 400px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--secondary-bg);
    }

    /* Keybinds */
    .keybind-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--primary-bg);
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .keybind-input {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 5px 10px;
      color: white;
      font-family: 'Courier New', monospace;
    }

    /* Clicker Button */
    .click-button {
        width: 100%;
        padding: 15px;
        background: var(--accent-color); /* Matches quick-btn */
        color: white;
        font-size: 18px;
        font-weight: 700;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
    }
    .click-button:hover {
        background: var(--accent-secondary);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(var(--accent-color), 0.4);
    }
    .click-count-display {
        font-family: 'Orbitron', monospace;
        font-size: 48px;
        font-weight: 900;
        color: var(--accent-color);
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: var(--primary-bg); /* Add background */
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }

    /* Daily Quotes & Random Facts content styling */
    #randomFact, #dailyQuote {
        background-color: var(--primary-bg); /* Background for text content */
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        line-height: 1.5;
        font-style: italic;
        color: var(--text-primary);
    }

    /* Announcement Bar */
    .announcement-bar {
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px 20px;
      overflow: hidden; /* Crucial for the moving text */
      margin-bottom: 20px; /* Space between announcement and panels */
      position: relative;
    }

    .announcement-content {
      white-space: nowrap; /* Keep text on a single line */
      display: inline-block; /* Essential for animation */
      padding-left: 100%; /* Start the text off-screen to the right */
      color: var(--accent-color); /* Make the text stand out */
      font-weight: bold;
      animation: marquee 20s linear infinite; /* Adjust time as needed for speed */
    }

    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); } /* Move fully to the left */
    }

    /* Reset Popup styles */
    .reset-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26, 26, 26, 0.98);
      backdrop-filter: blur(10px);
      border: 3px solid var(--accent-color);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      z-index: 1001; /* Above login box */
      box-shadow: 0 0 40px rgba(255, 69, 0, 0.6);
      width: 350px;
      max-width: 90%;
      display: none; /* Hidden by default */
    }

    .reset-popup p {
      margin-bottom: 20px;
      font-size: 1.1em;
      color: var(--text-primary);
    }

    .reset-popup .reset-field {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      background: var(--primary-bg);
      color: var(--text-primary);
      font-size: 16px;
      text-align: center;
    }

    .reset-popup button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .reset-popup button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 69, 0, 0.3);
    }

    /* New styles for the main menu buttons */
    .main-menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
      margin-bottom: 30px; /* Space before the panels grid */
    }

    .main-menu-btn {
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
    }

    .main-menu-btn i {
      font-size: 32px;
      color: var(--accent-color);
      margin-bottom: 10px;
    }

    .main-menu-btn:hover {
      background: var(--accent-color);
      color: white;
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(var(--accent-color), 0.3);
    }

    .main-menu-btn:hover i {
      color: white;
    }

    /* Style for wifi info board */
    .wifi-info-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .wifi-network-card {
      background: var(--primary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .wifi-network-card h4 {
      font-size: 1.1em;
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 10px;
    }

    .wifi-network-card div {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed var(--border-color);
      font-size: 0.9em;
    }

    .wifi-network-card div:last-child {
      border-bottom: none;
    }

    .wifi-network-card span:first-child {
      font-weight: 500;
      color: var(--text-secondary);
    }
    .wifi-network-card span:last-child {
      color: var(--text-primary);
    }

    /* Basic styling for text popups */
    .text-popup-content {
      background: var(--primary-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .text-popup-content h3 {
      font-size: 1.2em;
      color: var(--accent-color);
      margin-bottom: 10px;
    }

    .text-popup-content ul {
        list-style-type: disc;
        margin-left: 20px;
    }
    .text-popup-content ol {
        list-style-type: decimal;
        margin-left: 20px;
    }
    .text-popup-content a {
        color: var(--accent-secondary);
        text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .dashboard-quickbar .search-group {
            flex-direction: column; /* Stack search bar and time info on smaller screens */
            max-width: 100%;
            align-items: flex-start; /* Align text left */
        }
        .dashboard-quickbar .quickbar-time-info {
            width: 100%;
            justify-content: space-between;
        }
        .dashboard-quickbar .quick-btn-group {
            width: 100%; /* Make buttons take full width when stacked */
            justify-content: center;
        }
        .search-container {
            max-width: 100%;
        }
    }
    @media (max-width: 768px) {
      .login-box {
        width: 90%;
        margin: 20px auto;
      }
      
      .panels-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-quickbar {
        flex-direction: column;
        gap: 10px;
      }
      
      .search-container {
        max-width: 100%;
      }
      .main-menu-grid {
          grid-template-columns: 1fr;
      }
    }

    /* Loading Animation */
    .loading-cube {
      width: 60px;
      height: 60px;
      position: relative;
      transform-style: preserve-3d;
      animation: loadingRotate 1.5s infinite linear;
    }

    .loading-face {
      position: absolute;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, var(--accent-color), var(--accent-secondary));
      border: 1px solid #fff;
      opacity: 0.9;
    }

    .loading-face.front { transform: rotateY(0deg) translateZ(30px); }
    .loading-face.back { transform: rotateY(180deg) translateZ(30px); }
    .loading-face.right { transform: rotateY(90deg) translateZ(30px); }
    .loading-face.left { transform: rotateY(-90deg) translateZ(30px); }
    .loading-face.top { transform: rotateX(90deg) translateZ(30px); }
    .loading-face.bottom { transform: rotateX(-90deg) translateZ(30px); }

    @keyframes loadingRotate {
      0% { transform: rotateX(0deg) rotateY(0deg); }
      100% { transform: rotateX(360deg) rotateY(360deg); }
    }

    /* Hidden by default */
    .hidden { display: none !important; }
  </style>
</head>
<body>

<!-- Initialization Screen -->
<div id="initScreen" class="init-screen">
  <div class="rotating-cube">
    <div class="cube-face front"></div>
    <div class="cube-face back"></div>
    <div class="cube-face right"></div>
    <div class="cube-face left"></div>
    <div class="cube-face top"></div>
    <div class="cube-face bottom"></div>
  </div>
  <div id="initText" class="init-text">Initializing System...</div>
  <div class="code-rain" id="codeRain"></div>
</div>

<!-- Login Screen -->
<div id="loginScreen" class="login-container hidden">
  <div class="login-quickbar">
    <div class="flex items-center gap-2">
      <button class="panic-btn" onclick="window.open('https://clever.com', '_blank')">
        <i class="fas fa-exclamation-triangle"></i> Panic
      </button>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="adjustZoom(0.1)"><i class="fas fa-search-plus"></i> Zoom In</button>
      <button onclick="adjustZoom(-0.1)"><i class="fas fa-search-minus"></i> Zoom Out</button>
    </div>
  </div>

  <div class="login-box" id="loginBox">
    <h2><i class="fas fa-shield-alt"></i> Private System</h2>
    
    <div class="input-group">
      <input type="text" id="username" placeholder="Enter Username..." autocomplete="off">
    </div>
    
    <div class="input-group">
      <input type="password" id="password" placeholder="Enter Password..." autocomplete="off">
    </div>
    
    <div class="input-group">
      <input type="text" id="userID" placeholder="Enter User Identifier..." autocomplete="off">
    </div>

    <div class="toggle-container">
      <span>Show Password</span>
      <div class="toggle-switch" id="showPasswordToggle">
        <div class="toggle-slider"></div>
      </div>
    </div>

    <button class="submit-btn" id="submitBtn">
      <i class="fas fa-sign-in-alt"></i> ACCESS SYSTEM
    </button>

    <div id="errorMsg" class="text-red-400 mt-4 text-sm"></div>
    <div id="attemptsText" class="text-yellow-400 mt-2 text-sm">Attempts Left: 5</div>
  </div>

  <div class="time-date-box">
    <div class="time-display" id="currentTime">00:00:00</div>
    <div class="date-display" id="currentDate">Loading...</div>
    <div class="toggle-container mt-4">
      <span>24-Hour Format</span>
      <div class="toggle-switch" id="timeFormatToggle">
        <div class="toggle-slider"></div>
      </div>
    </div>
  </div>

  <!-- Reset Counter Popup (initially hidden) -->
  <div id="resetPopup" class="reset-popup" role="dialog" aria-modal="true" aria-hidden="true">
    <p>System Locked. Enter reset code to continue:</p>
    <input type="password" id="resetField" class="reset-field" placeholder="Enter Reset Code...">
    <button id="resetBtn">Reset Attempts</button>
  </div>

</div>

<!-- Loading Screen -->
<div id="loadingScreen" class="init-screen hidden">
  <div class="loading-cube">
    <div class="cube-face front"></div>
    <div class="cube-face back"></div>
    <div class="cube-face right"></div>
    <div class="cube-face left"></div>
    <div class="cube-face top"></div>
    <div class="cube-face bottom"></div>
  </div>
  <div class="init-text">Loading Dashboard...</div>
  <div class="code-rain" id="loadingCodeRain"></div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="dashboard">
  <!-- Welcome Notification -->
  <div id="welcomeNotification" class="notification">
    <i class="fas fa-user-check"></i> Welcome <span id="loggedUser">User</span>!
  </div>

  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div>
      <h1 class="text-2xl font-bold"><i class="fas fa-tachometer-alt"></i> Enhanced Private Dashboard</h1>
      <p class="text-sm opacity-80">User: <span id="currentUser">Beta.user</span> | ID: <span id="currentUserID">281573</span></p>
    </div>
    <div class="bg-white text-black px-4 py-2 rounded-lg font-bold">
      Version 2.0.0
    </div>
  </div>

  <!-- Quick Bar with Search, Session Time, Real Time, and Buttons -->
  <div class="dashboard-quickbar">
    <!-- Left Section: Search and Time Displays -->
    <div class="search-group">
        <div class="search-container">
            <input type="text" class="search-bar" id="searchBar" placeholder="Search panels, features...">
            <button class="search-btn" onclick="performSearch()"><i class="fas fa-search"></i></button>
        </div>
        <div class="quickbar-time-info">Session Time: <span id="quickbarSessionTime" class="quickbar-time-value">00:00:00</span></div>
        <div class="quickbar-time-info">Real Time: <span id="quickbarCurrentTime" class="quickbar-time-value">00:00:00</span></div>
    </div>
    
    <!-- Right Section: All other buttons -->
    <div class="quick-btn-group">
      <button class="quick-btn" onclick="togglePanel('settingsModal')">
        <i class="fas fa-cog"></i> Settings
      </button>
      <button class="quick-btn" onclick="togglePanel('timerPanel')">
        <i class="fas fa-stopwatch"></i> Timer
      </button>
      <button class="quick-btn" onclick="togglePanel('notesPanel')">
        <i class="fas fa-pen"></i> Notes
      </button>
      <button class="quick-btn" onclick="showStats()">
        <i class="fas fa-chart-bar"></i> Stats
      </button>
      <button class="quick-btn" onclick="takeScreenshot()">
          <i class="fas fa-camera"></i> Screenshot
      </button>
      <button class="quick-btn" onclick="togglePanelsGridVisibility()">
          <i class="fas fa-toggle-on"></i> Toggle Sections
      </button>
      <button class="quick-btn" onclick="adjustZoom(0.1)">
          <i class="fas fa-search-plus"></i> Zoom In
      </button>
      <button class="quick-btn" onclick="adjustZoom(-0.1)">
          <i class="fas fa-search-minus"></i> Zoom Out
      </button>
      <button class="quick-btn" onclick="restartSystem()">
          <i class="fas fa-redo-alt"></i> Restart
      </button>
      <button class="quick-btn panic-btn" onclick="window.open('https://clever.com', '_blank')">
          <i class="fas fa-exclamation-triangle"></i> Panic
      </button>
      <button class="quick-btn" onclick="toggleTheme()">
        <i class="fas fa-palette"></i> Theme
      </button>
      <button class="quick-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- Announcement Bar (newly added) -->
  <div class="announcement-bar mt-4">
      <div class="announcement-content">
          <p id="announcementText">Important System Announcement: Scheduled maintenance this weekend. System may experience brief interruptions. Please save your work regularly!</p>
      </div>
  </div>

  <!-- New Main Menu Buttons Section -->
  <div class="main-menu-grid">
    <button class="main-menu-btn" onclick="togglePanel('schoolWifiInfoModal')">
      <i class="fas fa-wifi"></i> School Wifi Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('ipadRestrictionsModal')">
      <i class="fas fa-tablet-alt"></i> School iPad Restrictions
    </button>
    <button class="main-menu-btn" onclick="togglePanel('studentHandbooksInfoModal')">
      <i class="fas fa-book-open"></i> Student Handbooks Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('schoolBuildingMapInfoModal')">
      <i class="fas fa-map-marked-alt"></i> School Building Map Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('studentWebsitesInfoModal')">
      <i class="fas fa-globe"></i> Student Websites Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('teacherWebsitesInfoModal')">
      <i class="fas fa-chalkboard-teacher"></i> Teacher Websites Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('schoolPhoneDirectoryInfoModal')">
      <i class="fas fa-phone-alt"></i> School Phone Directory Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('schoolCameraInfoModal')">
      <i class="fas fa-video"></i> School Camera Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('schoolInfoModal')">
      <i class="fas fa-school"></i> School Information
    </button>
    <button class="main-menu-btn" onclick="togglePanel('exploitingToolsModal')">
      <i class="fas fa-tools"></i> Exploiting Tools
    </button>
    <button class="main-menu-btn" onclick="togglePanel('bypassingToolsModal')">
      <i class="fas fa-user-secret"></i> Bypassing Tools
    </button>
    <button class="main-menu-btn" onclick="togglePanel('vpnWebsitesModal')">
      <i class="fas fa-shield-alt"></i> VPN Websites
    </button>
    <button class="main-menu-btn" onclick="togglePanel('gamingWebsitesModal')">
      <i class="fas fa-gamepad"></i> Gaming Websites
    </button>
    <button class="main-menu-btn" onclick="togglePanel('musicWebsitesModal')">
      <i class="fas fa-music"></i> Music Websites
    </button>
    <button class="main-menu-btn" onclick="togglePanel('keyboardTricksModal')">
      <i class="fas fa-keyboard"></i> Keyboard Tricks
    </button>
  </div>

  <!-- Main Panels Grid -->
  <div class="panels-grid" id="panelsGrid">
    <!-- Calendar Panel -->
    <div class="panel" data-panel="calendar">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-calendar"></i> Calendar</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="minimizePanel(this)"><i class="fas fa-minus"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar will be generated here -->
      </div>
    </div>

    <!-- Important Dates Panel -->
    <div class="panel" data-panel="importantDates">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-star"></i> Important Dates</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="clearImportantDates()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="content">
        <input type="date" id="importantDateDay" class="important-date-input" value="2025-08-24">
        <input type="time" id="importantDateTime" class="important-date-input" value="09:00">
        <input type="text" id="importantDateEvent" class="important-date-event-input" placeholder="Event Description...">
        <button class="quick-btn w-full mt-2" onclick="addImportantDate()">Add Event</button>
        <div id="importantDatesList" class="mt-4 max-h-40 overflow-y-auto space-y-2">
            <!-- Important dates will be populated here -->
        </div>
      </div>
    </div>

    <!-- Random Facts Panel -->
    <div class="panel" data-panel="facts">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-lightbulb"></i> Random Facts</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="refreshFact()"><i class="fas fa-sync"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="randomFact" class="text-sm">
        Did you know? The human brain contains approximately 86 billion neurons!
      </div>
    </div>

    <!-- Daily Quotes Panel -->
    <div class="panel" data-panel="quotes">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-quote-left"></i> Daily Quote</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="refreshQuote()"><i class="fas fa-sync"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="dailyQuote" class="text-sm italic">
        "The only way to do great work is to love what you do." - Steve Jobs
      </div>
    </div>

    <!-- Updates Panel -->
    <div class="panel" data-panel="updates">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-sync-alt"></i> System Updates</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="space-y-2" id="systemUpdatesList">
        <!-- System updates will be populated here -->
      </div>
    </div>

    <!-- Notifications Panel -->
    <div class="panel" data-panel="notifications">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-bell"></i> Notifications</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="clearNotifications()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="notificationsList" class="space-y-2">
        <!-- Notifications will be added here client-side -->
      </div>
    </div>

    <!-- Activity Logs Panel -->
    <div class="panel" data-panel="activityLogs">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-list"></i> Activity Logs</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="downloadActivityLogs()"><i class="fas fa-download"></i></button>
          <button class="panel-btn" onclick="clearActivityLogs()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="activityLogsList" class="max-h-40 overflow-y-auto">
        <!-- Activity logs will be populated here -->
      </div>
    </div>

    <!-- Error Log Panel -->
    <div class="panel" data-panel="errorLog">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-bug"></i> Error Log</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="downloadErrorLogs()"><i class="fas fa-download"></i></button>
          <button class="panel-btn" onclick="clearErrorLogs()"><i class="fas fa-trash"></i></button>
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="errorLogsList" class="max-h-40 overflow-y-auto space-y-2">
        <!-- Error logs will be populated here -->
      </div>
    </div>

    <!-- Login History Panel -->
    <div class="panel" data-panel="loginHistory">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-history"></i> Login History</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="loginHistoryList" class="space-y-2 max-h-40 overflow-y-auto">
        <!-- Login history will be populated here -->
      </div>
    </div>

    <!-- Mouse Clicker Panel -->
    <div class="panel" data-panel="mouseClicker">
      <div class="panel-header">
        <div class="panel-title"><i class="fas fa-mouse-pointer"></i> Mouse Clicker</div>
        <div class="panel-controls">
          <button class="panel-btn" onclick="closePanel(this)"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="content">
        <div id="clickCountDisplay" class="click-count-display">0</div>
        <button class="click-button" onclick="incrementClickCounter()">Click Me!</button>
        <div class="mouse-clicker-controls">
            <button class="quick-btn mt-2" onclick="resetClickCounter()"><i class="fas fa-undo-alt"></i> Reset</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-cog"></i> System Settings</h2>
        <button onclick="togglePanel('settingsModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="settings-grid" id="userSettingsGrid">
        <div class="setting-item">
          <span>Dark Mode</span>
          <div class="toggle-switch" id="darkModeToggle" data-setting="darkMode" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Auto-save Notes</span>
          <div class="toggle-switch" id="autoSaveNotesToggle" data-setting="autoSaveNotes" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Sound Notifications</span>
          <div class="toggle-switch" id="soundNotificationsToggle" data-setting="soundNotifications" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Auto-refresh Data</span>
          <div class="toggle-switch" id="autoRefreshDataToggle" data-setting="autoRefreshData" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Compact View</span>
          <div class="toggle-switch" id="compactViewToggle" data-setting="compactView" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Show Animations</span>
          <div class="toggle-switch" id="showAnimationsToggle" data-setting="showAnimations" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>High Contrast</span>
          <div class="toggle-switch" id="highContrastToggle" data-setting="highContrast" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Auto-backup</span>
          <div class="toggle-switch" id="autoBackupToggle" data-setting="autoBackup" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Security Mode</span>
          <div class="toggle-switch" id="securityModeToggle" data-setting="securityMode" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Advanced Logging</span>
          <div class="toggle-switch" id="advancedLoggingToggle" data-setting="advancedLogging" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Performance Mode</span>
          <div class="toggle-switch" id="performanceModeToggle" data-setting="performanceMode" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Developer Mode</span>
          <div class="toggle-switch" id="developerModeToggle" data-setting="developerMode" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Experimental Features</span>
          <div class="toggle-switch" id="experimentalFeaturesToggle" data-setting="experimentalFeatures" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Data Compression</span>
          <div class="toggle-switch" id="dataCompressionToggle" data-setting="dataCompression" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span>Real-time Sync</span>
          <div class="toggle-switch" id="realtimeSyncToggle" data-setting="realtimeSync" onclick="toggleSetting(this)">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>

      <!-- Keybinds Section -->
      <div class="mt-8">
        <h3 class="text-xl font-bold text-orange-500 mb-4"><i class="fas fa-keyboard"></i> Keybinds Configuration</h3>
        <div class="space-y-3" id="keybindsList">
          <div class="keybind-item">
            <span>Open Settings</span>
            <input type="text" class="keybind-input" value="Ctrl+," placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>Quick Search</span>
            <input type="text" class="keybind-input" value="Ctrl+K" placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>New Note</span>
            <input type="text" class="keybind-input" value="Ctrl+N" placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>Save All</span>
            <input type="text" class="keybind-input" value="Ctrl+S" placeholder="Press keys...">
          </div>
          <div class="keybind-item">
            <span>Toggle Theme</span>
            <input type="text" class="keybind-input" value="Ctrl+T" placeholder="Press keys...">
          </div>
        </div>
      </div>

      <!-- Theme Selector -->
      <div class="mt-8">
        <h3 class="text-xl font-bold text-orange-500 mb-4"><i class="fas fa-palette"></i> Accent Theme Selection</h3>
        <div class="theme-selector" id="themeSelector">
          <div class="theme-option" style="background: linear-gradient(135deg, #ff4500, #ff6b35);" onclick="applyAccentTheme('orange', event)">Orange</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #0066cc, #004499);" onclick="applyAccentTheme('blue', event)">Blue</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #00cc44, #009933);" onclick="applyAccentTheme('green', event)">Green</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #cc0044, #990033);" onclick="applyAccentTheme('red', event)">Red</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #8800cc, #6600aa);" onclick="applyAccentTheme('purple', event)">Purple</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #ffaa00, #ff8800);" onclick="applyAccentTheme('amber', event)">Amber</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #00aaaa, #008888);" onclick="applyAccentTheme('teal', event)">Teal</div>
          <div class="theme-option" style="background: linear-gradient(135deg, #ff0088, #cc0066);" onclick="applyAccentTheme('pink', event)">Pink</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Timer Panel -->
  <div id="timerPanel" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-stopwatch"></i> Timer & Stopwatch</h2>
        <button onclick="togglePanel('timerPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Stopwatch -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-lg font-bold mb-4 text-center">Stopwatch</h3>
          <div class="timer-display" id="stopwatchDisplay">00:00:00</div>
          <div class="timer-controls">
            <button class="tool-btn" onclick="startStopwatch()"><i class="fas fa-play"></i> Start</button>
            <button class="tool-btn" onclick="pauseStopwatch()"><i class="fas fa-pause"></i> Pause</button>
            <button class="tool-btn" onclick="resetStopwatch()"><i class="fas fa-stop"></i> Reset</button>
          </div>
        </div>

        <!-- Timer -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-lg font-bold mb-4 text-center">Countdown Timer</h3>
          <div class="timer-display" id="timerDisplay">00:00:00</div>
          <div class="flex justify-center gap-2 mb-4">
            <input type="number" id="timerHours" class="w-16 p-2 bg-gray-700 rounded text-center" placeholder="HH" min="0" max="23">
            <input type="number" id="timerMinutes" class="w-16 p-2 bg-gray-700 rounded text-center" placeholder="MM" min="0" max="59">
            <input type="number" id="timerSeconds" class="w-16 p-2 bg-gray-700 rounded text-center" placeholder="SS" min="0" max="59">
          </div>
          <div class="timer-controls">
            <button class="tool-btn" onclick="startTimer()"><i class="fas fa-play"></i> Start</button>
            <button class="tool-btn" onclick="pauseTimer()"><i class="fas fa-pause"></i> Pause</button>
            <button class="tool-btn" onclick="resetTimer()"><i class="fas fa-stop"></i> Reset</button>
          </div>
        </div>
      </div>

      <!-- Reminders -->
      <div class="mt-8">
        <h3 class="text-lg font-bold mb-4"><i class="fas fa-bell"></i> Reminders</h3>
        <div class="flex gap-2 mb-4">
          <input type="text" id="reminderText" class="flex-1 p-2 bg-gray-700 rounded" placeholder="Reminder text...">
          <input type="datetime-local" id="reminderTime" class="p-2 bg-gray-700 rounded">
          <button class="tool-btn" onclick="addReminder()"><i class="fas fa-plus"></i> Add</button>
        </div>
        <div id="remindersList" class="space-y-2">
          <!-- Reminders will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Panel -->
  <div id="notesPanel" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-pen"></i> Enhanced Notes</h2>
        <button onclick="togglePanel('notesPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="drawing-tools">
        <button class="tool-btn active" data-tool="pen" onclick="selectTool(this, 'pen')">
          <i class="fas fa-pen"></i> Pen
        </button>
        <button class="tool-btn" data-tool="brush" onclick="selectTool(this, 'brush')">
          <i class="fas fa-paint-brush"></i> Brush
        </button>
        <button class="tool-btn" data-tool="eraser" onclick="selectTool(this, 'eraser')">
          <i class="fas fa-eraser"></i> Eraser
        </button>
        <button class="tool-btn" data-tool="text" onclick="selectTool(this, 'text')">
          <i class="fas fa-text-height"></i> Text
        </button>
        <button class="tool-btn" data-tool="line" onclick="selectTool(this, 'line')">
          <i class="fas fa-minus"></i> Line
        </button>
        <button class="tool-btn" data-tool="rectangle" onclick="selectTool(this, 'rectangle')">
          <i class="fas fa-square"></i> Rectangle
        </button>
        <button class="tool-btn" data-tool="circle" onclick="selectTool(this, 'circle')">
          <i class="fas fa-circle"></i> Circle
        </button>
        
        <div class="flex items-center gap-2">
          <label class="text-sm">Color:</label>
          <input type="color" id="penColor" class="color-picker" value="#ff4500">
        </div>
        
        <div class="flex items-center gap-2">
          <label class="text-sm">Thickness:</label>
          <input type="range" id="penThickness" class="thickness-slider" min="1" max="20" value="2">
        </div>
        
        <div class="flex items-center gap-2">
          <label class="text-sm">Material:</label>
          <select id="penMaterial" class="bg-gray-700 text-white p-1 rounded">
            <option value="solid">Solid</option>
            <option value="dashed">Dashed</option>
            <option value="dotted">D-otted</option>
          </select>
        </div>
        
        <button class="tool-btn" onclick="clearCanvas()">
          <i class="fas fa-trash"></i> Clear
        </button>
        <button class="tool-btn" onclick="saveCanvas()">
          <i class="fas fa-save"></i> Save
        </button>
      </div>
      
      <canvas id="drawingCanvas" width="760" height="400" class="w-full border border-gray-600 rounded mt-4 bg-white cursor-crosshair"></canvas>
      
      <!-- Text Notes Section -->
      <div class="mt-6">
        <h3 class="text-lg font-bold mb-2"><i class="fas fa-sticky-note"></i> Text Notes</h3>
        <textarea id="textNotes" class="w-full h-32 p-3 bg-gray-700 rounded resize-none" placeholder="Type your notes here..."></textarea>
        <div class="flex gap-2 mt-2">
          <button class="tool-btn" onclick="saveTextNotes()"><i class="fas fa-save"></i> Save Notes</button>
          <button class="tool-btn" onclick="clearTextNotes()"><i class="fas fa-trash"></i> Clear Notes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculator Panel (Removed from quickbar, still available in code for direct call if needed) -->
  <div id="calculatorPanel" class="settings-modal" style="display:none;"> 
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-calculator"></i> Calculator & Converter</h2>
        <button onclick="togglePanel('calculatorPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Calculator -->
        <div class="calculator">
          <h3 class="text-lg font-bold mb-4 text-center">Calculator</h3>
          <div class="calc-display" id="calcDisplay">0</div>
          <div class="calc-buttons">
            <button class="calc-btn" onclick="clearCalc()">C</button>
            <button class="calc-btn" onclick="deleteLast()">⌫</button>
            <button class="calc-btn operator" onclick="appendToCalc('/')">/</button>
            <button class="calc-btn operator" onclick="appendToCalc('*')">×</button>
            
            <button class="calc-btn" onclick="appendToCalc('7')">7</button>
            <button class="calc-btn" onclick="appendToCalc('8')">8</button>
            <button class="calc-btn" onclick="appendToCalc('9')">9</button>
            <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
            
            <button class="calc-btn" onclick="appendToCalc('4')">4</button>
            <button class="calc-btn" onclick="appendToCalc('5')">5</button>
            <button class="calc-btn" onclick="appendToCalc('6')">6</button>
            <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
            
            <button class="calc-btn" onclick="appendToCalc('1')">1</button>
            <button class="calc-btn" onclick="appendToCalc('2')">2</button>
            <button class="calc-btn" onclick="appendToCalc('3')">3</button>
            <button class="calc-btn equals" onclick="calculateResult()" rowspan="2">=</button>
            
            <button class="calc-btn" onclick="appendToCalc('0')" style="grid-column: span 2;">0</button>
            <button class="calc-btn" onclick="appendToCalc('.')">.</button>
          </div>
        </div>

        <!-- Unit Converter -->
        <div class="bg-gray-800 p-6 rounded-lg">
          <h3 class="text-lg font-bold mb-4 text-center">Unit Converter</h3>
          <div class="space-y-4">
            <select id="conversionType" class="w-full p-2 bg-gray-700 rounded" onchange="updateConversionUnits()">
              <option value="length">Length</option>
              <option value="weight">Weight</option>
              <option value="temperature">Temperature</option>
              <option value="volume">Volume</option>
            </select>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm mb-1">From:</label>
                <select id="fromUnit" class="w-full p-2 bg-gray-700 rounded">
                  <option value="m">Meters</option>
                  <option value="km">Kilometers</option>
                  <option value="cm">Centimeters</option>
                  <option value="mm">Millimeters</option>
                  <option value="in">Inches</option>
                  <option value="ft">Feet</option>
                </select>
                <input type="number" id="fromValue" class="w-full p-2 bg-gray-700 rounded mt-2" placeholder="Enter value" oninput="convertUnits()">
              </div>
              
              <div>
                <label class="block text-sm mb-1">To:</label>
                <select id="toUnit" class="w-full p-2 bg-gray-700 rounded" onchange="convertUnits()">
                  <option value="m">Meters</option>
                  <option value="km">Kilometers</option>
                  <option value="cm">Centimeters</option>
                  <option value="mm">Millimeters</option>
                  <option value="in">Inches</option>
                  <option value="ft">Feet</option>
                </select>
                <input type="number" id="toValue" class="w-full p-2 bg-gray-700 rounded mt-2" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Media Panel (Removed from quickbar, still available in code for direct call if needed) -->
  <div id="mediaPanel" class="settings-modal" style="display:none;">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-play"></i> Media Player</h2>
        <button onclick="togglePanel('mediaPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="media-container">
        <div class="flex gap-2 mb-4">
          <input type="url" id="mediaUrl" class="media-input" placeholder="Enter YouTube URL...">
          <button class="tool-btn" onclick="loadMedia()"><i class="fas fa-play"></i> Load</button>
        </div>
        <iframe id="mediaFrame" class="media-frame" src="" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <!-- Stats Panel -->
  <div id="statsPanel" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-chart-bar"></i> Usage Statistics</h2>
        <button onclick="togglePanel('statsPanel')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number" id="buttonPresses">0</div>
          <div class="stat-label">Button Presses</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="toggleSwitches">0</div>
          <div class="stat-label">Toggle Switches</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="panelsOpened">0</div>
          <div class="stat-label">Panels Opened</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="panelsClosed">0</div>
          <div class="stat-label">Panels Closed</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="searchQueries">0</div>
          <div class="stat-label">Search Queries</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="sessionTime">00:00:00</div>
          <div class="stat-label">Session Time</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="mt-8">
        <canvas id="statsChart" style="height: 400px;"></canvas>
      </div>
    </div>
  </div>


  <!-- NEW MODALS FOR USER-REQUESTED BUTTONS -->

  <!-- School Wifi Information Modal -->
  <div id="schoolWifiInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-wifi"></i> School Wifi Information</h2>
        <button onclick="togglePanel('schoolWifiInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="wifi-info-board" id="wifiInfoBoard">
        <!-- Wifi network cards will be populated here -->
      </div>
    </div>
  </div>

  <!-- School iPad Restrictions Modal -->
  <div id="ipadRestrictionsModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-tablet-alt"></i> School iPad Restrictions</h2>
        <button onclick="togglePanel('ipadRestrictionsModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button class="quick-btn w-full" onclick="toggleSubPanel('ipadRestrictionsText', 'Restrictions')">
          <i class="fas fa-ban"></i> Restrictions
        </button>
        <button class="quick-btn w-full" onclick="toggleSubPanel('ipadBypassesText', 'Bypasses')">
          <i class="fas fa-unlock-alt"></i> Bypasses
        </button>
      </div>
      <div id="ipadRestrictionsText" class="text-popup-content mt-4 hidden">
          <h3>Restrictions</h3>
          <p>Coming soon</p>
      </div>
      <div id="ipadBypassesText" class="text-popup-content mt-4 hidden">
          <h3>Bypasses</h3>
          <p>Coming soon</p>
      </div>
    </div>
  </div>

  <!-- Student Handbooks Information Modal -->
  <div id="studentHandbooksInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-book-open"></i> Student Handbooks Information</h2>
        <button onclick="togglePanel('studentHandbooksInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="studentHandbooksLinks">
        <!-- Handbook links will be populated here -->
      </div>
    </div>
  </div>

  <!-- School Building Map Information Modal -->
  <div id="schoolBuildingMapInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-map-marked-alt"></i> School Building Map Information</h2>
        <button onclick="togglePanel('schoolBuildingMapInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content" id="schoolBuildingMapContent">
          <h3>Building Map Display</h3>
          <p>Building Map Coming Soon</p>
      </div>
    </div>
  </div>

  <!-- Student Website's Information Modal -->
  <div id="studentWebsitesInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-globe"></i> Student Websites Information</h2>
        <button onclick="togglePanel('studentWebsitesInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content">
          <h3>Student Resources</h3>
          <ul id="studentWebsitesList">
              <!-- Student website links will be populated here -->
          </ul>
      </div>
    </div>
  </div>

  <!-- Teacher Websites Information Modal -->
  <div id="teacherWebsitesInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-chalkboard-teacher"></i> Teacher Websites Information</h2>
        <button onclick="togglePanel('teacherWebsitesInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content">
          <h3>Teacher Resources</h3>
          <ul id="teacherWebsitesList">
              <!-- Teacher website links will be populated here -->
          </ul>
      </div>
    </div>
  </div>

  <!-- School Phone Directory Information Modal -->
  <div id="schoolPhoneDirectoryInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-phone-alt"></i> School Phone Directory Information</h2>
        <button onclick="togglePanel('schoolPhoneDirectoryInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content" id="phoneDirectoryContent">
          <h3>Teacher Directory</h3>
          <p>Teachers name: [N/A]</p>
          <p>Room Number: [N/A]</p>
          <p>Call ID: [N/A]</p>
          <p class="mt-4 text-yellow-400">Update Coming Soon!</p>
      </div>
    </div>
  </div>

  <!-- School Camera Information Modal -->
  <div id="schoolCameraInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-video"></i> School Camera Information</h2>
        <button onclick="togglePanel('schoolCameraInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content" id="schoolCameraInfoContent">
          <p>Update Coming Soon</p>
      </div>
    </div>
  </div>

  <!-- School Information Modal -->
  <div id="schoolInfoModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-school"></i> School Information</h2>
        <button onclick="togglePanel('schoolInfoModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content" id="schoolInfoContent">
          <!-- School info will be populated here -->
      </div>
    </div>
  </div>

  <!-- Exploiting Tools Modal -->
  <div id="exploitingToolsModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-tools"></i> Exploiting Tools</h2>
        <button onclick="togglePanel('exploitingToolsModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="exploitingToolsLinks">
        <!-- Exploiting tools links will be populated here -->
      </div>
    </div>
  </div>

  <!-- Bypassing Tools Modal -->
  <div id="bypassingToolsModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-user-secret"></i> Bypassing Tools</h2>
        <button onclick="togglePanel('bypassingToolsModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="bypassingToolButtons">
        <button class="quick-btn w-full" onclick="toggleSubPanel('bathroomBypassText', 'Bathroom Bypass')">
          Bathroom Bypass
        </button>
        <button class="quick-btn w-full" onclick="toggleSubPanel('wifiBypassText', 'Wifi Bypass')">
          Wifi Bypass
        </button>
        <button class="quick-btn w-full" onclick="toggleSubPanel('teacherMonitoringBypassText', 'Teacher Monitering Bypass')">
          Teacher Monitering Bypass
        </button>
        <button class="quick-btn w-full" onclick="toggleSubPanel('comingSoon1', 'Coming Soon')">
          Coming Soon
        </button>
        <button class="quick-btn w-full" onclick="toggleSubPanel('comingSoon2', 'Coming Soon')">
          Coming Soon
        </button>
        <button class="quick-btn w-full" onclick="toggleSubPanel('comingSoon3', 'Coming Soon')">
          Coming Soon
        </button>
      </div>
      <div id="bathroomBypassText" class="text-popup-content mt-4 hidden">
          <h3>Bathroom Bypass</h3>
          <p>COMING SOON</p>
      </div>
      <div id="wifiBypassText" class="text-popup-content mt-4 hidden">
          <h3>Wifi Bypass</h3>
          <p>Go to School Wifi Information</p>
      </div>
      <div id="teacherMonitoringBypassText" class="text-popup-content mt-4 hidden">
          <h3>Teacher Monitoring Bypass</h3>
          <p>COMING SOON</p>
      </div>
      <div id="comingSoon1" class="text-popup-content mt-4 hidden">
          <h3>Coming Soon</h3>
          <p>COMING SOON</p>
      </div>
      <div id="comingSoon2" class="text-popup-content mt-4 hidden">
          <h3>Coming Soon</h3>
          <p>COMING SOON</p>
      </div>
      <div id="comingSoon3" class="text-popup-content mt-4 hidden">
          <h3>Coming Soon</h3>
          <p>COMING SOON</p>
      </div>
    </div>
  </div>

  <!-- VPN Websites Modal -->
  <div id="vpnWebsitesModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-shield-alt"></i> VPN Websites</h2>
        <button onclick="togglePanel('vpnWebsitesModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content">
          <h3>Recommended VPNs</h3>
          <ul id="vpnWebsitesList">
              <!-- VPN website links will be populated here -->
          </ul>
      </div>
    </div>
  </div>

  <!-- Gaming Websites Modal -->
  <div id="gamingWebsitesModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-gamepad"></i> Gaming Websites</h2>
        <button onclick="togglePanel('gamingWebsitesModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content">
          <ul id="gamingWebsitesList">
              <!-- Gaming website links will be populated here -->
          </ul>
      </div>
    </div>
  </div>

  <!-- Music Websites Modal -->
  <div id="musicWebsitesModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-music"></i> Music Websites</h2>
        <button onclick="togglePanel('musicWebsitesModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content">
          <ul id="musicWebsitesList">
              <!-- Music website links will be populated here -->
          </ul>
      </div>
    </div>
  </div>

  <!-- Keyboard Tricks Modal -->
  <div id="keyboardTricksModal" class="settings-modal">
    <div class="settings-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-orange-500"><i class="fas fa-keyboard"></i> Keyboard Tricks</h2>
        <button onclick="togglePanel('keyboardTricksModal')" class="text-2xl text-gray-400 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="text-popup-content" id="keyboardTricksContent">
          <!-- Keyboard tricks will be populated here -->
      </div>
    </div>
  </div>


</div>

<script>
// --- Frontend API Client ---
// REPLACE THIS WITH YOUR ACTUAL VERCEL BACKEND URL! It should end with /api.
const API_BASE_URL = 'https://discord-controlled-backend-nkaxiqbvi-mehlbaums-projects.vercel.app/api'; 

// Helper to get JWT token from session storage
const getAuthToken = () => sessionStorage.getItem('token');

// Helper for making authenticated requests
const authenticatedFetch = async (endpoint, options = {}) => {
    const token = getAuthToken();
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers,
    };
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            headers,
        });

        // If unauthorized or token expired, force logout
        if (response.status === 401 || response.status === 403) {
            console.error('Authentication expired or unauthorized. Logging out.');
            showNotification('Session expired or unauthorized. Please log in again.', 'error');
            setTimeout(logout, 2000); // Redirect to login after 2 seconds
            return; // Prevent further processing
        }

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: `Server error: ${response.statusText}` }));
            throw new Error(errorData.message || 'API request failed');
        }
        return response.json();
    } catch (error) {
        console.error('Network or API call error:', error);
        throw new Error(`Failed to connect to API or server error: ${error.message}`);
    }
};

window.api = {
    // --- Auth & User ---
    login: async (username, password, userID_display) => {
        return authenticatedFetch('/auth/login', {
            method: 'POST',
            body: JSON.stringify({ username, password, userID_display }),
        });
    },
    registerUser: async (username, password, userID_display, name, role = 'standard') => {
        return authenticatedFetch('/auth/register', {
            method: 'POST',
            body: JSON.stringify({ username, password, userID_display, name, role }),
        });
    },
    getMe: async () => {
        return authenticatedFetch('/users/me');
    },
    updateUserSettings: async (settings) => {
        return authenticatedFetch('/users/me/settings', {
            method: 'PUT',
            body: JSON.stringify(settings),
        });
    },
    getUserSettings: async () => {
        return authenticatedFetch('/users/me/settings');
    },
    getUserStats: async () => {
        return authenticatedFetch('/users/me/stats');
    },
    updateUserStats: async (statsData) => {
        return authenticatedFetch('/users/me/stats', {
            method: 'PUT',
            body: JSON.stringify(statsData),
        });
    },
    resetLoginAttempts: async (resetCode) => { // This will be a new backend endpoint
        return authenticatedFetch('/auth/reset-attempts', {
            method: 'POST',
            body: JSON.stringify({ resetCode }),
        });
    },

    // --- Logs ---
    logLoginAttempt: async (data) => {
        // Frontend sends client-side data for the attempt
        return authenticatedFetch('/log/login-attempt', {
            method: 'POST',
            body: JSON.stringify(data),
        });
    },
    logActivity: async (description, context = 'dashboard') => {
        return authenticatedFetch('/log/activity', {
            method: 'POST',
            body: JSON.stringify({ description, context }),
        });
    },
    logError: async (message, context = 'frontend', stackTrace = null) => {
        return authenticatedFetch('/log/error', {
            method: 'POST',
            body: JSON.stringify({ message, context, stackTrace }),
        });
    },
    getLoginHistory: async () => {
        return authenticatedFetch('/users/me/login-history');
    },
    getActivityLogs: async () => {
        return authenticatedFetch('/users/me/activity-logs');
    },
    getErrorLogs: async () => {
        return authenticatedFetch('/users/me/error-logs');
    },
    clearActivityLogs: async () => {
        return authenticatedFetch('/users/me/activity-logs/clear', { method: 'DELETE' });
    },
    clearErrorLogs: async () => {
        return authenticatedFetch('/users/me/error-logs/clear', { method: 'DELETE' });
    },
    downloadActivityLogs: () => `${API_BASE_URL}/users/me/activity-logs/download`, // Direct link to backend download endpoint
    downloadErrorLogs: () => `${API_BASE_URL}/users/me/error-logs/download`, // Direct link

    // --- Important Dates ---
    getImportantDates: async () => {
        return authenticatedFetch('/users/me/important-dates');
    },
    addImportantDate: async (datetime, event) => {
        return authenticatedFetch('/users/me/important-dates', {
            method: 'POST',
            body: JSON.stringify({ datetime, event }),
        });
    },
    clearImportantDates: async () => {
        return authenticatedFetch('/users/me/important-dates/clear', { method: 'DELETE' });
    },

    // --- Notes ---
    getNotes: async () => {
        return authenticatedFetch('/users/me/notes');
    },
    saveNotes: async (textContent, drawingData) => {
        return authenticatedFetch('/users/me/notes', {
            method: 'PUT', // Using PUT for upsert (create if not exists, update if exists)
            body: JSON.stringify({ text_content: textContent, drawing_data: drawingData }),
        });
    },
    clearNotes: async () => {
        return authenticatedFetch('/users/me/notes', { method: 'DELETE' });
    },

    // --- Clicker ---
    getClickCount: async () => {
        return authenticatedFetch('/users/me/click-count');
    },
    incrementClickCount: async () => {
        return authenticatedFetch('/users/me/click-count/increment', { method: 'POST' });
    },
    resetClickCount: async () => {
        return authenticatedFetch('/users/me/click-count/reset', { method: 'POST' });
    },

    // --- Global Settings/Info ---
    getGlobalData: async () => { // Fetches all global data in one go
        return authenticatedFetch('/global/all'); // Will create this endpoint on backend
    },
    getSystemVersion: async () => { // Specific endpoint for version
        return authenticatedFetch('/global/version');
    },
};

// Global variables (from your original code)
let currentUsername = ''; // Renamed from currentUser to avoid conflict with backend user object
let currentUserID_display = ''; // Renamed from currentUserID
let currentSessionUser = null; // Stores the full user object after successful login
let is24HourFormat = false;
let currentZoom = 1;

let attempts = 5; // Default local attempts, but backend will be authoritative
let isLightMode = false; // Added to track current theme

// Timer variables
let stopwatchInterval = null;
let stopwatchTime = 0;
let timerInterval = null;
let timerTime = 0;
let isStopwatchRunning = false;
let isTimerRunning = false;

// Drawing variables
let isDrawing = false;
let currentTool = 'pen';
let currentColor = '#ff4500';
let currentThickness = 2;
let canvas, ctx;

// Calculator variables
let calcDisplay = '';
let calcOperation = '';

// DOM elements for login and reset
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const userIDInput = document.getElementById('userID');
const submitBtn = document.getElementById('submitBtn');
const errorMsg = document.getElementById('errorMsg');
const attemptsText = document.getElementById('attemptsText');
const resetPopup = document.getElementById('resetPopup');
const resetField = document.getElementById('resetField');
const resetBtn = document.getElementById('resetBtn');


// Helper to parse user agent for more details (stays client-side)
function parseUserAgent() {
    const ua = navigator.userAgent;
    let browserName = "Unknown Browser";
    let browserVersion = "Unknown";
    let os = "Unknown OS";
    let osVersion = "Unknown";
    let engine = "Unknown Engine";
    let deviceType = "Desktop";

    // Browser Detection
    if (/Chrome/.test(ua) && !/Edge/.test(ua) && !/OPR/.test(ua)) {
        browserName = "Chrome";
        browserVersion = ua.match(/Chrome\/([\d.]+)/)?.[1] || "Unknown";
        engine = "Blink";
    } else if (/Firefox/.test(ua)) {
        browserName = "Firefox";
        browserVersion = ua.match(/Firefox\/([\d.]+)/)?.[1] || "Unknown";
        engine = "Gecko";
    } else if (/Safari/.test(ua) && !/Chrome/.test(ua) && !/Edge/.test(ua)) {
        browserName = "Safari";
        browserVersion = ua.match(/Version\/([\d.]+)/)?.[1] || "Unknown";
        engine = "WebKit";
    } else if (/Edge/.test(ua)) {
        browserName = "Edge";
        browserVersion = ua.match(/Edge\/([\d.]+)/)?.[1] || "Unknown";
        engine = "EdgeHTML/Blink"; // Edge switched to Chromium/Blink
    } else if (/OPR|Opera/.test(ua)) {
        browserName = "Opera";
        browserVersion = ua.match(/(?:OPR|Opera)\/([\d.]+)/)?.[1] || "Unknown";
        engine = "Blink/Presto";
    } else if (/Trident/.test(ua) || /MSIE/.test(ua)) {
        browserName = "Internet Explorer";
        browserVersion = ua.match(/(?:MSIE |rv:)(\d+\.?\d*)/)?.[1] || "Unknown";
        engine = "Trident";
    }

    // OS Detection
    if (/Windows NT 10.0/.test(ua)) { os = "Windows"; osVersion = "10"; }
    else if (/Windows NT 6.3/.test(ua)) { os = "Windows"; osVersion = "8.1"; }
    else if (/Windows NT 6.2/.test(ua)) { os = "Windows"; osVersion = "8"; }
    else if (/Windows NT 6.1/.test(ua)) { os = "Windows"; osVersion = "7"; }
    else if (/Macintosh|Mac OS X/.test(ua)) { os = "macOS"; osVersion = ua.match(/Mac OS X ([\d_.]+)/)?.[1]?.replace(/_/g, '.') || "Unknown"; }
    else if (/Android/.test(ua)) { os = "Android"; osVersion = ua.match(/Android ([\d.]+)/)?.[1] || "Unknown"; deviceType = "Mobile"; }
    else if (/iPhone|iPad|iPod/.test(ua)) { os = "iOS"; osVersion = ua.match(/OS ([\d_.]+)/)?.[1]?.replace(/_/g, '.') + " (iOS)" || "Unknown"; deviceType = "Mobile"; }
    else if (/Linux/.test(ua)) { os = "Linux"; osVersion = "Unknown"; }

    // Device Type refinement
    if (/(tablet|ipad|playbook|silk)|(android(?!.*mobile))/i.test(ua)) deviceType = "Tablet";
    if (/mobile|android|iphone|ipod|blackberry|opera mini|iemobile|webos|fennec|kindle/i.test(ua)) deviceType = "Mobile";

    return { browserName, browserVersion, os, osVersion, engine, deviceType };
}

// Functions to get browser, device, and connection information (returning fields array)
function getBrowserDetailedInfo() {
    const parsedUA = parseUserAgent();
    return {
        userAgent: navigator.userAgent || "N/A",
        browserName: parsedUA.browserName,
        browserVersion: parsedUA.browserVersion,
        osName: parsedUA.os,
        osVersion: parsedUA.osVersion,
        engine: parsedUA.engine,
        deviceTypeParsed: parsedUA.deviceType,
        cookiesEnabled: navigator.cookieEnabled,
        doNotTrack: navigator.doNotTrack,
        language: navigator.language,
        onlineStatus: navigator.onLine,
        referrer: document.referrer,
        currentUrl: window.location.href,
        windowInnerSize: `${window.innerWidth || 'N/A'}x${window.innerHeight || 'N/A'}`,
        windowOuterSize: `${window.outerWidth || 'N/A'}x${window.outerHeight || 'N/A'}`,
        viewportSize: `${document.documentElement.clientWidth || 'N/A'}x${document.documentElement.clientHeight || 'N/A'}`,
        webglSupport: (() => { try { return !!document.createElement('canvas').getContext('webgl'); } catch (e) { return false; } })(),
        canvasSupport: !!window.CanvasRenderingContext2D,
        webRTCSupoprt: (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia),
        geolocationSupport: !!navigator.geolocation,
        webSocketsSupport: !!window.WebSocket,
        webWorkersSupport: !!window.Worker,
        batteryStatusAPI: !!navigator.getBattery,
        vibrationAPI: !!navigator.vibrate,
        mediaDevicesAPI: !!navigator.mediaDevices,
        vrArAPI: !!navigator.xr,
        gamepadAPI: !!navigator.getGamepads,
        webShareAPI: !!navigator.share,
        credentialManagementAPI: !!navigator.credentials,
        paymentRequestAPI: !!window.PaymentRequest,
        webAuthenticationAPI: !!navigator.credentials && !!navigator.credentials.create,
        indexedDBSupport: !!window.indexedDB,
        webSQLDBSupport: !!window.openDatabase,
        offscreenCanvasSupport: !!window.OffscreenCanvas,
        permissionsAPI: !!navigator.permissions,
        clipboardAPI: !!navigator.clipboard
    };
}

function getDeviceDetailedInfo() {
    const parsedUA = parseUserAgent();
    return {
        osName: parsedUA.os,
        osVersion: parsedUA.osVersion,
        platform: navigator.platform,
        deviceTypeParsed: parsedUA.deviceType,
        screenTotalWidth: screen.width,
        screenTotalHeight: screen.height,
        screenAvailableWidth: screen.availWidth,
        screenAvailableHeight: screen.availHeight,
        colorDepth: screen.colorDepth,
        pixelDepth: screen.pixelDepth,
        devicePixelRatio: window.devicePixelRatio,
        screenOrientation: screen.orientation?.type,
        hardwareConcurrency: navigator.hardwareConcurrency,
        deviceMemory: navigator.deviceMemory,
        maxTouchPoints: navigator.maxTouchPoints,
        touchScreenSupport: (('ontouchstart' in window) || (navigator.maxTouchPoints > 0)),
        keyboardMapSupport: !!navigator.keyboard,
        pointerLockAPI: !!document.exitPointerLock,
        speechRecognitionAPI: !!(window.SpeechRecognition || window.webkitSpeechRecognition),
        speechSynthesisAPI: !!window.speechSynthesis,
        usbAPI: !!navigator.usb,
        bluetoothAPI: !!navigator.bluetooth,
        nfcAPI: !!navigator.nfc,
        accelerometerSupport: !!window.DeviceMotionEvent,
        gyroscopeSupport: !!window.DeviceOrientationEvent,
        magnetometerSupport: !!window.DeviceOrientationEvent,
        ambientLightSensorSupport: 'ondevicelight' in window,
        proximitySensorSupport: 'ondeviceproximity' in window,
        mediaCapabilitiesAPI: !!navigator.mediaCapabilities,
        virtualKeyboardAPI: !!navigator.virtualKeyboard,
        userActivationAPI: !!navigator.userActivation
    };
}

function getConnectionDetailedInfo() {
    const nav = navigator;
    return {
        onlineStatus: nav.onLine,
        connectionType: nav.connection?.type,
        effectiveConnectionType: nav.connection?.effectiveType,
        downlinkSpeed: nav.connection?.downlink,
        rtt: nav.connection?.rtt,
        saveDataMode: nav.connection?.saveData,
        ipAddress: "N/A (Client-side JS cannot detect public IP directly)",
        vpnDetected: "N/A (Requires server-side lookup)",
        proxyDetected: "N/A (Requires server-side lookup)",
        publicIpv6: "N/A (Client-side JS cannot detect directly)",
        localIpAddresses: "N/A (Requires WebRTC or server-side interaction with user consent)",
        networkDownlinkMax: nav.connection?.downlinkMax,
        networkMeteredConnection: nav.connection?.metered,
        networkTypeDetailed: nav.connection?.typeDetailed,
        bandwidthEstimate: nav.connection?.bandwidthEstimate,
        webTransportAPI: !!window.WebTransport,
        beaconAPI: !!nav.sendBeacon,
        backgroundSyncAPI: !!('serviceWorker' in nav && nav.serviceWorker && nav.serviceWorker.ready && nav.serviceWorker.ready.then && 'sync' in (nav.serviceWorker.controller || {})),
        fetchPriorityAPI: !!(new Request('/', {priority: 'high'})).priority,
        dnsPrefetchingSupport: true, // Generally available
        preloadSupport: true, // Generally available
        prerenderSupport: !!document.createElement('link').relList?.supports('prerender'),
        networkInformationAPI: !!nav.connection,
        serviceWorkerStatus: 'serviceWorker' in nav ? (nav.serviceWorker.controller ? 'Active' : 'Supported') : 'Not Supported',
        bluetoothEnabled: nav.bluetooth?.getAvailability ? "Check Required" : "N/A",
    };
}


// Update attempts display (local representation, backend is authoritative)
function updateAttemptsText() {
    attemptsText.textContent = `Attempts Left: ${attempts}`;
}

// Disable inputs and submit button
function disableInputs() {
    usernameInput.disabled = true;
    passwordInput.disabled = true;
    userIDInput.disabled = true;
    submitBtn.disabled = true;
}

// Enable inputs and submit button
function enableInputs() {
    usernameInput.disabled = false;
    passwordInput.disabled = false;
    userIDInput.disabled = false;
    submitBtn.disabled = false;
}

// Show reset popup
function showResetPopup() {
    resetPopup.style.display = 'flex';
    resetPopup.setAttribute('aria-hidden', 'false');
    resetField.focus();
}

// Hide reset popup
function hideResetPopup() {
    resetPopup.style.display = 'none';
    resetPopup.setAttribute('aria-hidden', 'true');
    resetField.value = '';
}


// Reset Counter logic (Frontend initiates, Backend verifies)
async function resetCounter() {
    const enteredCode = resetField.value.trim();
    if (!enteredCode) {
        showError('Please enter a reset code.');
        return;
    }

    try {
        const response = await window.api.resetLoginAttempts(enteredCode); // Call to backend
        if (response.success) {
            attempts = response.attemptsLeft; // Update local attempts from backend
            updateAttemptsText();
            enableInputs();
            hideResetPopup();
            errorMsg.textContent = '';
            showNotification("Login attempts reset successfully!");
            await window.api.logActivity("Login attempts reset via code (success).", "login_reset");
        } else {
            alert(response.message || 'Incorrect reset code. Try again.');
            await window.api.logActivity("Login attempts reset via code (failure).", "login_reset");
        }
    } catch (error) {
        console.error('Error resetting login attempts:', error);
        showError(`Failed to reset attempts: ${error.message}`);
        await window.api.logError(`Frontend: Failed to reset login attempts: ${error.message}`, "login_reset", error.stack);
    }
}


// Initialization sequence
window.addEventListener('load', () => {
    // Check for existing token and try to log in silently
    const token = getAuthToken();
    if (token) {
        // Attempt to get user data from backend with existing token
        // This ensures if the page refreshes, user is still logged in
        window.api.getMe()
            .then(user => {
                currentSessionUser = user;
                currentUsername = user.username;
                currentUserID_display = user.userID_display;
                initializeDashboard();
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.add('active');
            })
            .catch(error => {
                console.error('Auto-login failed with existing token:', error);
                // Token invalid or expired, clear it and show login screen
                sessionStorage.removeItem('token');
                startInitialization();
            });
    } else {
        startInitialization();
    }
    
    // Initial display of date/time
    startClock();
});

function startInitialization() {
    generateCodeRain('codeRain');
    
    setTimeout(() => {
        document.getElementById('initText').textContent = 'Initializing Login Page...';
        setTimeout(() => {
            document.getElementById('initScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }, 2000);
    }, 3000);
}

function generateCodeRain(containerId) {
    const container = document.getElementById(containerId);
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    
    // Clear existing rain if any
    container.innerHTML = ''; 

    // Create a lot of initial characters quickly
    for(let i = 0; i < 50; i++) {
        createCodeChar(container, chars);
    }

    // Then continuously add new ones
    setInterval(() => {
        createCodeChar(container, chars);
    }, 100);
}

function createCodeChar(container, chars) {
    const char = document.createElement('div');
    char.className = 'code-char';
    char.textContent = chars[Math.floor(Math.random() * chars.length)];
    char.style.left = Math.random() * 100 + '%';
    char.style.animationDelay = Math.random() * 2 + 's';
    char.style.animationDuration = (2 + Math.random() * 3) + 's'; // Vary duration
    container.appendChild(char);
    
    setTimeout(() => {
      if (char.parentNode) {
        char.parentNode.removeChild(char);
      }
    }, parseFloat(char.style.animationDuration.replace('s', '')) * 1000); // Remove after animation
}


function startClock() {
  updateClock();
  setInterval(updateClock, 1000);
}

function updateClock() {
  const now = new Date();
  const timeOptions = { hour12: !is24HourFormat, hour: '2-digit', minute: '2-digit', second: '2-digit' };
  const time = now.toLocaleTimeString('en-US', timeOptions);
  
  const date = now.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  // Update login screen time
  document.getElementById('currentTime').textContent = time;
  document.getElementById('currentDate').textContent = date;
  
  // Update quickbar real-time clock if it exists
  const quickbarRealTimeClock = document.getElementById('quickbarCurrentTime');
  if (quickbarRealTimeClock) {
    quickbarRealTimeClock.textContent = time;
  }
}

async function adjustZoom(delta) {
    currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
    document.body.style.zoom = currentZoom;
    await window.api.logActivity('Zoom adjusted to ' + Math.round(currentZoom * 100) + '%', 'system_control');
}

// Toggle functions
function setupToggles() {
  // Show password toggle
  document.getElementById('showPasswordToggle').addEventListener('click', function() {
    this.classList.toggle('active');
    const passwordField = document.getElementById('password');
    passwordField.type = this.classList.contains('active') ? 'text' : 'password';
    // No backend log for this, as it's a privacy-related UI toggle
  });

  // 24-hour format toggle
  document.getElementById('timeFormatToggle').addEventListener('click', async function() {
    this.classList.toggle('active');
    is24HourFormat = this.classList.contains('active');
    await window.api.logActivity('Time format toggled to ' + (is24HourFormat ? '24-hour' : '12-hour'), 'settings');
  });

  // Event listeners for individual settings toggles
  document.querySelectorAll('#userSettingsGrid .toggle-switch').forEach(toggle => {
      toggle.addEventListener('click', async function() {
          const settingKey = this.dataset.setting;
          const newValue = !this.classList.contains('active'); // Toggling means it's the opposite of current state
          this.classList.toggle('active', newValue);

          // Update local theme if it's the dark mode toggle
          if (settingKey === 'darkMode') {
              if (newValue) {
                  document.body.classList.remove('light-theme');
              } else {
                  document.body.classList.add('light-theme');
              }
              isLightMode = !newValue; // Update local tracker
              updateStatsChartTheme();
          }

          if (currentSessionUser) {
              const updatedSettings = { ...currentSessionUser.settings, [settingKey]: newValue };
              try {
                  const response = await window.api.updateUserSettings(updatedSettings);
                  currentSessionUser.settings = response.settings; // Update local user object
                  showNotification(`Setting '${settingKey}' updated to '${newValue}'.`);
                  await window.api.logActivity(`Setting toggled: ${settingKey} to ${newValue}`, 'settings');
              } catch (error) {
                  console.error('Error updating setting:', error);
                  showError(`Failed to update setting: ${error.message}`);
                  await window.api.logError(`Frontend: Failed to update setting ${settingKey}: ${error.message}`, 'settings', error.stack);
                  // Revert UI if API fails
                  this.classList.toggle('active', !newValue);
              }
          }
      });
  });
}

// Login function
async function attemptLogin() {
    const username = usernameInput.value;
    const password = passwordInput.value;
    const userID_display = userIDInput.value; // Renamed to match backend field

    // Get client-side environment info for backend logging
    const browserInfo = getBrowserDetailedInfo();
    const deviceInfo = getDeviceDetailedInfo();
    const connectionInfo = getConnectionDetailedInfo();

    // Log the attempt to backend (backend handles webhooks, attempt counting, locking)
    try {
        const response = await window.api.login(username, password, userID_display);

        // If login successful
        sessionStorage.setItem('token', response.token); // Store JWT
        currentSessionUser = response;
        currentUsername = response.username;
        currentUserID_display = response.userID_display;
        // The backend will have reset attempts, so local attempts variable should reflect initial state
        attempts = 5; 

        await successfulLogin(); // Proceed to dashboard

    } catch (error) {
        // Login failed (e.g., 401 Invalid credentials, 403 Account locked)
        console.error('Login attempt failed:', error.message);
        const errorData = JSON.parse(error.message); // Assuming backend sends JSON error

        // Update local attempts (backend is authoritative but UI needs to react)
        // If the error message contains attempts left, extract it
        const attemptsLeftMatch = errorData.message ? errorData.message.match(/Attempts left: (\d+)/) : null;
        if (attemptsLeftMatch) {
            attempts = parseInt(attemptsLeftMatch[1]);
        } else if (errorData.message && errorData.message.includes('Account locked')) {
            attempts = 0;
        }

        // Send detailed failed login info to backend for logging and webhooks
        await window.api.logLoginAttempt({
            username: username || '[empty]',
            password: '***', // Never send raw password in logs
            userID_display: userID_display || '[empty]',
            success: false,
            reason: errorData.message || 'Unknown reason',
            attempts_left: attempts,
            browser_info: browserInfo,
            device_info: deviceInfo,
            connection_info: connectionInfo,
            timestamp: new Date().toISOString()
        });

        failedLogin(errorData.message); // Display error on UI
    }
}

async function successfulLogin() {
  // Update UI with logged-in user data
  document.getElementById('loggedUser').textContent = currentSessionUser.name;
  document.getElementById('currentUser').textContent = currentSessionUser.name;
  document.getElementById('currentUserID').textContent = currentSessionUser.userID_display;
  
  // Show loading screen
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('loadingScreen').classList.remove('hidden');
  generateCodeRain('loadingCodeRain');
  
  setTimeout(async () => {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('dashboard').classList.add('active');
    await initializeDashboard();
    showNotification(`Welcome ${currentSessionUser.name}!`);
    await window.api.logActivity('Dashboard initialized', 'system_init');
  }, 3000);
}

async function failedLogin(errorMessage) {
  updateAttemptsText(); // Update UI immediately based on local 'attempts'

  document.getElementById('loginBox').classList.add('error-shake');
  
  setTimeout(() => {
    document.getElementById('loginBox').classList.remove('error-shake');
  }, 500);
  
  errorMsg.textContent = errorMessage; // Display error message from backend

  if (attempts <= 0) { // If backend indicated lock
    disableInputs();
    showResetPopup();
    await window.api.logActivity('Login attempts exceeded, system locked.', 'security');
  }
}

function showError(message) {
  errorMsg.textContent = message;
  // No need to log this specific function call to backend, as underlying logic (like login attempt) already logs errors.
  setTimeout(() => {
    errorMsg.textContent = '';
  }, 3000);
}

// Dashboard initialization
async function initializeDashboard() {
  stats.sessionStartTime = Date.now();
  
  // Set initial theme based on user settings
  if (currentSessionUser.settings.darkMode) {
      document.body.classList.remove('light-theme');
      isLightMode = false;
  } else {
      document.body.classList.add('light-theme');
      isLightMode = true;
  }
  // Apply accent theme
  applyAccentTheme(currentSessionUser.settings.accentTheme || 'orange');
  
  // Populate Settings Toggles
  for (const settingKey in currentSessionUser.settings) {
      const toggleElement = document.querySelector(`.toggle-switch[data-setting="${settingKey}"]`);
      if (toggleElement) {
          if (currentSessionUser.settings[settingKey]) {
              toggleElement.classList.add('active');
          } else {
              toggleElement.classList.remove('active');
          }
      }
  }

  // Populate Dashboard UI elements from backend
  await fetchAndPopulateDashboardData();

  // Initialize components
  generateCalendar();
  initializeCanvas();
  startSessionTimer(); 
  updateClock(); 
  // setInterval(updateClock, 1000); // Already called in startClock
  updateStats(); // Will fetch from backend
  
  await window.api.logActivity('Dashboard UI loaded', 'ui_load');
}

async function fetchAndPopulateDashboardData() {
    try {
        // Fetch user-specific data
        const [
            userSettings,
            userStats,
            userClickCount,
            importantDatesData,
            notesData,
            loginHistoryData,
            activityLogsData,
            errorLogsData
        ] = await Promise.all([
            window.api.getUserSettings().catch(e => { console.error("Error fetching user settings:", e); return currentSessionUser.settings; }),
            window.api.getUserStats().catch(e => { console.error("Error fetching user stats:", e); return currentSessionUser.stats; }),
            window.api.getClickCount().catch(e => { console.error("Error fetching click count:", e); return currentSessionUser.click_count; }),
            window.api.getImportantDates().catch(e => { console.error("Error fetching important dates:", e); return []; }),
            window.api.getNotes().catch(e => { console.error("Error fetching notes:", e); return { text_content: '', drawing_data: '' }; }),
            window.api.getLoginHistory().catch(e => { console.error("Error fetching login history:", e); return []; }),
            window.api.getActivityLogs().catch(e => { console.error("Error fetching activity logs:", e); return []; }),
            window.api.getErrorLogs().catch(e => { console.error("Error fetching error logs:", e); return []; })
        ]);

        // Update global user object with fetched data
        currentSessionUser.settings = userSettings;
        currentSessionUser.stats = userStats;
        currentSessionUser.click_count = userClickCount;
        
        // Populate UI
        await updateStats();
        await updateClickCountDisplay();
        await updateImportantDatesDisplay(importantDatesData);
        await updateNotesDisplay(notesData);
        await updateLoginHistoryDisplay(loginHistoryData);
        await updateActivityLogDisplay(activityLogsData);
        await updateErrorLogDisplay(errorLogsData);


        // Fetch global static content
        const globalData = await window.api.getGlobalData().catch(e => { 
            console.error("Error fetching global data:", e); 
            // Return defaults if API fails
            return {
                announcement_text: "Failed to load announcements.",
                random_facts: ["Failed to load facts."],
                daily_quotes: [{quote: "Failed to load quote.", author: "System"}],
                system_updates: ["Failed to load updates."],
                system_version: "N/A",
                wifi_info: [],
                ipad_restrictions: "Failed to load iPad restrictions.",
                ipad_bypasses: "Failed to load iPad bypasses.",
                student_handbooks: [],
                building_map_info: "Building Map Coming Soon (Failed to load).",
                student_websites: [],
                teacher_websites: [],
                phone_directory: [],
                camera_info: "Failed to load camera info.",
                school_info: {},
                exploiting_tools: [],
                bypassing_tools: {},
                vpn_websites: [],
                gaming_websites: [],
                music_websites: [],
                keyboard_tricks: []
            };
        });
        
        // Populate global UI elements
        document.getElementById('announcementText').textContent = globalData.announcement_text || "No announcement.";
        document.getElementById('randomFact').textContent = globalData.random_facts[Math.floor(Math.random() * globalData.random_facts.length)] || "No facts available.";
        const quote = globalData.daily_quotes[Math.floor(Math.random() * globalData.daily_quotes.length)];
        document.getElementById('dailyQuote').textContent = `"${quote.quote || 'No quote available.'}" - ${quote.author || 'Unknown'}`;
        await updateSystemUpdatesDisplay(globalData.system_updates);
        document.querySelector('.dashboard-header .bg-white').textContent = `Version ${globalData.system_version || 'N/A'}`; // Update version

        // Populate complex modals when dashboard loads (or on demand later)
        populateWifiInfo(globalData.wifi_info);
        document.getElementById('ipadRestrictionsText').querySelector('p').textContent = globalData.ipad_restrictions || "Coming soon";
        document.getElementById('ipadBypassesText').querySelector('p').textContent = globalData.ipad_bypasses || "Coming soon";
        populateLinks('studentHandbooksLinks', globalData.student_handbooks);
        document.getElementById('schoolBuildingMapContent').innerHTML = `<h3>Building Map Display</h3><p>${globalData.building_map_info || "Building Map Coming Soon"}</p>`;
        populateLinks('studentWebsitesList', globalData.student_websites, 'li');
        populateLinks('teacherWebsitesList', globalData.teacher_websites, 'li');
        populatePhoneDirectory(globalData.phone_directory);
        document.getElementById('schoolCameraInfoContent').innerHTML = `<p>${globalData.camera_info || "Update Coming Soon"}</p>`;
        populateSchoolInfo(globalData.school_info);
        populateLinks('exploitingToolsLinks', globalData.exploiting_tools);
        populateBypassingTools(globalData.bypassing_tools);
        populateLinks('vpnWebsitesList', globalData.vpn_websites, 'ul');
        populateLinks('gamingWebsitesList', globalData.gaming_websites, 'ul');
        populateLinks('musicWebsitesList', globalData.music_websites, 'ul');
        populateKeyboardTricks(globalData.keyboard_tricks);

    } catch (error) {
        console.error('Error fetching dashboard data:', error);
        showError(`Failed to load dashboard data: ${error.message}`);
        await window.api.logError(`Frontend: Failed to fetch dashboard data: ${error.message}`, 'dashboard_init', error.stack);
    }
}


function generateCalendar() {
  const calendar = document.getElementById('calendarGrid');
  calendar.innerHTML = '';
  
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  // Add day headers
  days.forEach(day => {
    const dayElement = document.createElement('div');
    dayElement.textContent = day;
    dayElement.className = 'calendar-cell text-xs font-bold text-gray-400';
    calendar.appendChild(dayElement);
  });
  
  // Add calendar days
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  
  // Empty cells for days before month starts
  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-cell';
    calendar.appendChild(emptyCell);
  }
  
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const dayCell = document.createElement('div');
    dayCell.textContent = day;
    dayCell.className = 'calendar-cell';
    
    if (day === today.getDate()) {
      dayCell.classList.add('today');
    }
    
    calendar.appendChild(dayCell);
  }
}

function initializeCanvas() {
  canvas = document.getElementById('drawingCanvas');
  ctx = canvas.getContext('2d');
  
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
}

function startDrawing(e) {
  isDrawing = true;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  ctx.beginPath();
  ctx.moveTo(x, y);
}

function draw(e) {
  if (!isDrawing) return;
  
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  ctx.lineWidth = currentThickness;
  ctx.lineCap = 'round';
  ctx.strokeStyle = currentTool === 'eraser' ? 'white' : currentColor;
  
  ctx.lineTo(x, y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x, y);
}

function stopDrawing() {
  isDrawing = false;
  ctx.beginPath();
}

// Session timer is client-side, but needs to update backend stats periodically
let sessionTimerInterval = null;
function startSessionTimer() {
  if (sessionTimerInterval) clearInterval(sessionTimerInterval); // Clear any existing
  
  stats.sessionStartTime = Date.now(); // Start of current browser session
  
  sessionTimerInterval = setInterval(async () => {
    if (stats.sessionStartTime) {
      const elapsed = Math.floor((Date.now() - stats.sessionStartTime) / 1000);
      const hours = Math.floor(elapsed / 3600);
      const minutes = Math.floor((elapsed % 3600) / 60);
      const seconds = elapsed % 60;
      
      const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      document.getElementById('sessionTime').textContent = timeString;
      document.getElementById('quickbarSessionTime').textContent = timeString;

      // Update backend stats every minute (or custom interval)
      if (elapsed % 60 === 0 && elapsed > 0 && currentSessionUser) { // Every 60 seconds
          try {
              // Fetch current stats, update sessionTime, then send back
              const latestStats = await window.api.getUserStats();
              latestStats.sessionTime = elapsed; // Update with current session elapsed time
              await window.api.updateUserStats(latestStats);
          } catch (error) {
              console.error('Error updating session time in backend:', error);
              await window.api.logError(`Frontend: Failed to update session time: ${error.message}`, 'stats', error.stack);
          }
      }
    }
  }, 1000); // Update every second
}


// Utility functions
async function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  if (!panel) return;

  const isVisible = panel.style.display === 'flex' || panel.style.display === 'block';
  
  if (panel.classList.contains('settings-modal')) {
    panel.style.display = isVisible ? 'none' : 'flex';
  } else { // For grid panels
    panel.style.display = isVisible ? 'none' : 'block';
  }

  if (!isVisible) {
    currentSessionUser.stats.panelsOpened++;
    await window.api.logActivity(`Panel opened: ${panelId}`, 'panel_control');
  } else {
    currentSessionUser.stats.panelsClosed++;
    await window.api.logActivity(`Panel closed: ${panelId}`, 'panel_control');
  }
  
  await updateStats(); // Update stats in UI and backend
}

// Function for sub-panels like iPad Restrictions sub-buttons or Bypassing Tools
async function toggleSubPanel(subPanelId, buttonText) {
    const subPanel = document.getElementById(subPanelId);
    if (!subPanel) return;

    const isVisible = subPanel.classList.contains('hidden') === false;

    const parentModal = subPanel.closest('.settings-content');
    if (parentModal) {
        parentModal.querySelectorAll('.text-popup-content').forEach(panel => {
            if (panel.id !== subPanelId) {
                panel.classList.add('hidden');
            }
        });
    }

    if (isVisible) {
        subPanel.classList.add('hidden');
        await window.api.logActivity(`Sub-panel closed: ${buttonText}`, 'panel_control');
    } else {
        subPanel.classList.remove('hidden');
        await window.api.logActivity(`Sub-panel opened: ${buttonText}`, 'panel_control');
        
        // Special logic for "Wifi Bypass" to guide user
        if (subPanelId === 'wifiBypassText') {
            const wifiInfoModal = document.getElementById('schoolWifiInfoModal');
            if (wifiInfoModal && wifiInfoModal.style.display === 'none') {
                showNotification("Redirecting to School Wifi Information...");
                // Optionally open the Wifi Info modal here after a short delay
                // setTimeout(() => togglePanel('schoolWifiInfoModal'), 1000);
            }
        }
    }
    // No explicit button press stat here, as the outer button click handler covers it.
    // updateStats(); // This is covered by the overall click listener
}


async function minimizePanel(button) {
  const panel = button.closest('.panel');
  const content = panel.querySelector('.panel-header').nextElementSibling;
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    button.innerHTML = '<i class="fas fa-minus"></i>';
  } else {
    content.style.display = 'none';
    button.innerHTML = '<i class="fas fa-plus"></i>';
  }
  
  await window.api.logActivity('Panel minimized/restored', 'panel_control');
}

async function closePanel(button) {
  const panel = button.closest('.panel');
  if (!panel) return; // Guard against null
  panel.style.display = 'none';
  currentSessionUser.stats.panelsClosed++;
  await window.api.logActivity(`Panel closed: ${panel.dataset.panel}`, 'panel_control');
  await updateStats();
}

async function performSearch() {
  const query = document.getElementById('searchBar').value.toLowerCase();
  if (!query) return;
  
  currentSessionUser.stats.searchQueries++;
  await window.api.logActivity(`Searched for: ${query}`, 'search');
  
  const panels = document.querySelectorAll('.panels-grid > .panel'); 
  let found = false;
  panels.forEach(panel => {
    const text = panel.textContent.toLowerCase();
    const panelTitle = panel.querySelector('.panel-title').textContent.toLowerCase();
    
    if (text.includes(query) || panelTitle.includes(query)) {
      panel.style.display = 'block'; 
      panel.style.border = '2px solid var(--accent-color)'; 
      found = true;
      setTimeout(() => {
        panel.style.border = '1px solid var(--border-color)';
      }, 2000);
    } else {
        // We're not hiding non-matching panels by default as per original, just highlighting.
    }
  });

  if (!found) {
      showNotification("No matching panels found.");
      await window.api.logError("Search failed: No matching panels found for query '" + query + "'.", 'search');
  }
  
  await updateStats();
}

// Centralized logging functions
async function logActivity(activity, context = 'dashboard') {
  try {
    await window.api.logActivity(activity, context);
    // Optionally update local activity list here if you want real-time feedback
    await updateActivityLogDisplay(); // Refresh the display
  } catch (error) {
    console.error('Error logging activity to backend:', error);
    showError(`Failed to log activity: ${error.message}`);
  }
}

async function updateActivityLogDisplay(initialLogs = null) {
  const container = document.getElementById('activityLogsList');
  if (!container) return;
  container.innerHTML = '';
  
  let logsToDisplay = initialLogs;
  if (!logsToDisplay) { // If not initial load, fetch fresh data
      try {
          logsToDisplay = await window.api.getActivityLogs();
      } catch (error) {
          console.error('Error fetching activity logs:', error);
          showError(`Failed to load activity logs: ${error.message}`);
          return;
      }
  }

  logsToDisplay.slice(0, 10).forEach(log => {
    const logElement = document.createElement('div');
    logElement.className = 'log-entry';
    logElement.innerHTML = `
      <span>${log.activity_description}</span>
      <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
    `;
    container.appendChild(logElement);
  });
}

async function logError(message, context = 'frontend', stackTrace = null) {
    try {
        await window.api.logError(message, context, stackTrace);
        await updateErrorLogDisplay(); // Refresh display
    } catch (error) {
        console.error('Error logging error to backend:', error);
        // Avoid infinite loop if logging fails due to another error
    }
}

async function updateErrorLogDisplay(initialErrors = null) {
    const container = document.getElementById('errorLogsList');
    if (!container) return;
    container.innerHTML = '';

    let errorsToDisplay = initialErrors;
    if (!errorsToDisplay) { // If not initial load, fetch fresh data
        try {
            errorsToDisplay = await window.api.getErrorLogs();
        } catch (error) {
            console.error('Error fetching error logs:', error);
            showError(`Failed to load error logs: ${error.message}`);
            return;
        }
    }

    errorsToDisplay.slice(0, 10).forEach(err => {
        const errorElement = document.createElement('div');
        errorElement.className = 'error-log-entry';
        errorElement.innerHTML = `
            <span>${err.message}</span>
            <span class="error-log-time">${new Date(err.timestamp).toLocaleTimeString()}</span>
        `;
        container.appendChild(errorElement);
    });
}

async function clearErrorLogs() {
    if (confirm("Are you sure you want to clear all error logs?")) {
        try {
            await window.api.clearErrorLogs();
            await updateErrorLogDisplay([]); // Clear UI immediately
            showNotification("Error logs cleared.");
            await window.api.logActivity("Error logs cleared.", 'logs_control');
        } catch (error) {
            console.error('Error clearing error logs:', error);
            showError(`Failed to clear error logs: ${error.message}`);
            await window.api.logError(`Frontend: Failed to clear error logs: ${error.message}`, 'logs_control', error.stack);
        }
    }
}

async function downloadErrorLogs() {
    try {
        // Direct link to backend endpoint that serves the file
        const downloadUrl = window.api.downloadErrorLogs(); 
        window.open(downloadUrl, '_blank'); // Open in new tab to trigger download
        showNotification("Error logs download initiated.");
        await window.api.logActivity("Error logs downloaded.", 'logs_control');
    } catch (error) {
        console.error('Error downloading error logs:', error);
        showError(`Failed to download error logs: ${error.message}`);
        await window.api.logError(`Frontend: Failed to download error logs: ${error.message}`, 'logs_control', error.stack);
    }
}

async function updateLoginHistoryDisplay(initialHistory = null) {
  const container = document.getElementById('loginHistoryList');
  if (!container) return;
  container.innerHTML = '';

  let historyToDisplay = initialHistory;
  if (!historyToDisplay) { // If not initial load, fetch fresh data
      try {
          historyToDisplay = await window.api.getLoginHistory();
      } catch (error) {
          console.error('Error fetching login history:', error);
          showError(`Failed to load login history: ${error.message}`);
          return;
      }
  }

  historyToDisplay.slice(0, 10).forEach(entry => { 
    const logElement = document.createElement('div');
    const statusClass = entry.success ? 'success' : 'failed';
    logElement.className = `login-entry-container ${statusClass}`;
    logElement.innerHTML = `
      <div class="flex-grow">
        <span class="login-entry-status">${entry.success ? 'SUCCESS' : 'FAILED'}:</span> 
        <span>User "${entry.username_attempted || 'unknown'}"</span>
      </div>
      <span class="login-entry-time">${new Date(entry.timestamp).toLocaleString()}</span>
    `;
    container.appendChild(logElement);
  });
}

// Important Dates functions
async function addImportantDate() {
    const dateInput = document.getElementById('importantDateDay').value;
    const timeInput = document.getElementById('importantDateTime').value;
    const eventInput = document.getElementById('importantDateEvent').value;

    if (!dateInput || !timeInput || !eventInput) {
        showError("Please fill in all important date fields.");
        return;
    }

    try {
        const fullDate = `${dateInput}T${timeInput}:00.000Z`; // Ensure ISO format with Z for UTC
        await window.api.addImportantDate(fullDate, eventInput);
        await updateImportantDatesDisplay(); // Refresh the list from backend
        showNotification("Important date added!");
        await window.api.logActivity(`Added important date: ${eventInput} on ${new Date(fullDate).toLocaleString()}`, 'important_dates');

        // Clear inputs
        document.getElementById('importantDateDay').value = new Date().toISOString().split('T')[0];
        document.getElementById('importantDateTime').value = "09:00";
        document.getElementById('importantDateEvent').value = '';
    } catch (error) {
        console.error('Error adding important date:', error);
        showError(`Failed to add important date: ${error.message}`);
        await window.api.logError(`Frontend: Failed to add important date: ${error.message}`, 'important_dates', error.stack);
    }
}

async function clearImportantDates() {
    if (confirm("Are you sure you want to clear all important dates?")) {
        try {
            await window.api.clearImportantDates();
            await updateImportantDatesDisplay([]); // Clear UI immediately
            showNotification("All important dates cleared.");
            await window.api.logActivity("All important dates cleared.", 'important_dates');
        } catch (error) {
            console.error('Error clearing important dates:', error);
            showError(`Failed to clear important dates: ${error.message}`);
            await window.api.logError(`Frontend: Failed to clear important dates: ${error.message}`, 'important_dates', error.stack);
        }
    }
}

async function updateImportantDatesDisplay(initialDates = null) {
    const container = document.getElementById('importantDatesList');
    if (!container) return;
    container.innerHTML = '';

    let datesToDisplay = initialDates;
    if (!datesToDisplay) { // If not initial load, fetch fresh data
        try {
            datesToDisplay = await window.api.getImportantDates();
        } catch (error) {
            console.error('Error fetching important dates:', error);
            showError(`Failed to load important dates: ${error.message}`);
            return;
        }
    }
    
    // Sort by date/time ascending
    datesToDisplay.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

    datesToDisplay.forEach(dateEntry => {
        const entryElement = document.createElement('div');
        entryElement.className = 'important-date-item';
        const formattedDate = new Date(dateEntry.datetime).toLocaleString();
        entryElement.innerHTML = `
            <div class="date-time">${formattedDate}</div>
            <div class="event-description">${dateEntry.event}</div>
        `;
        container.appendChild(entryElement);
    });
}


// Mouse Clicker functions
async function incrementClickCounter() {
    try {
        const response = await window.api.incrementClickCount();
        currentSessionUser.click_count = response.click_count; // Update local user object
        await updateClickCountDisplay();
        await window.api.logActivity('Mouse click incremented', 'mouse_clicker');
    } catch (error) {
        console.error('Error incrementing click counter:', error);
        showError(`Failed to increment click counter: ${error.message}`);
        await window.api.logError(`Frontend: Failed to increment click counter: ${error.message}`, 'mouse_clicker', error.stack);
    }
}

async function resetClickCounter() {
    if (confirm("Are you sure you want to reset the click counter?")) {
        try {
            const response = await window.api.resetClickCount();
            currentSessionUser.click_count = response.click_count; // Should be 0
            await updateClickCountDisplay();
            showNotification("Click counter reset!");
            await window.api.logActivity('Mouse clicker reset', 'mouse_clicker');
        } catch (error) {
            console.error('Error resetting click counter:', error);
            showError(`Failed to reset click counter: ${error.message}`);
            await window.api.logError(`Frontend: Failed to reset click counter: ${error.message}`, 'mouse_clicker', error.stack);
        }
    }
}

async function updateClickCountDisplay(initialCount = null) {
    const display = document.getElementById('clickCountDisplay');
    if (display) {
        let count = initialCount;
        if (count === null && currentSessionUser) { // If not initial load, get from current session user or API
            count = currentSessionUser.click_count;
            if (count === undefined) { // Fallback if not loaded into user obj yet
                 try {
                     count = await window.api.getClickCount();
                     currentSessionUser.click_count = count; // Cache it
                 } catch (error) {
                     console.error('Error fetching click count:', error);
                     count = 0; // Default to 0 on error
                 }
            }
        } else if (count === null) { // Before user session starts
            count = 0;
        }
        display.textContent = count;
    }
}

// Stats functions
async function updateStats() {
  if (!currentSessionUser) return;

  try {
      const fetchedStats = await window.api.getUserStats();
      currentSessionUser.stats = fetchedStats; // Update local user object

      document.getElementById('buttonPresses').textContent = currentSessionUser.stats.buttonPresses;
      document.getElementById('toggleSwitches').textContent = currentSessionUser.stats.toggleSwitches;
      document.getElementById('panelsOpened').textContent = currentSessionUser.stats.panelsOpened;
      document.getElementById('panelsClosed').textContent = currentSessionUser.stats.panelsClosed;
      document.getElementById('searchQueries').textContent = currentSessionUser.stats.searchQueries;
      // Session time is updated by startSessionTimer
      document.getElementById('sessionTime').textContent = formatSecondsToHHMMSS(currentSessionUser.stats.sessionTime);

  } catch (error) {
      console.error('Error fetching user stats:', error);
      showError(`Failed to load user stats: ${error.message}`);
      await window.api.logError(`Frontend: Failed to fetch user stats: ${error.message}`, 'stats', error.stack);
  }
}

function formatSecondsToHHMMSS(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}


async function downloadActivityLogs() {
    try {
        const downloadUrl = window.api.downloadActivityLogs(); 
        window.open(downloadUrl, '_blank');
        showNotification('Activity logs download initiated!');
        await window.api.logActivity('Activity logs downloaded', 'logs_control');
    } catch (error) {
        console.error('Error downloading activity logs:', error);
        showError(`Failed to download activity logs: ${error.message}`);
        await window.api.logError(`Frontend: Failed to download activity logs: ${error.message}`, 'logs_control', error.stack);
    }
}

async function showStats() {
  await togglePanel('statsPanel'); // Assuming this opens the modal
  if (!document.getElementById('statsPanel').style.display === 'flex') return; // Only draw chart if panel is visible

  await updateStats(); // Ensure latest stats are fetched

  // Create stats chart
  const ctx = document.getElementById('statsChart').getContext('2d');
  if (Chart.getChart(ctx)) {
    Chart.getChart(ctx).destroy();
  }
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Button Presses', 'Toggle Switches', 'Panels Opened', 'Panels Closed', 'Search Queries', 'Mouse Clicks'],
      datasets: [{
        data: [
            currentSessionUser.stats.buttonPresses, 
            currentSessionUser.stats.toggleSwitches, 
            currentSessionUser.stats.panelsOpened, 
            currentSessionUser.stats.panelsClosed, 
            currentSessionUser.stats.searchQueries, 
            currentSessionUser.click_count // Use click_count from user object
        ],
        backgroundColor: ['#ff4500', '#ff6b35', '#00ff41', '#ffaa00', '#0066cc', '#8800cc']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
          }
        }
      }
    }
  });
  await window.api.logActivity('Stats panel viewed', 'stats');
}

// Timer functions (client-side only for now, can add backend reminders later)
function startStopwatch() {
  if (!isStopwatchRunning) {
    isStopwatchRunning = true;
    stopwatchInterval = setInterval(() => {
      stopwatchTime++;
      updateStopwatchDisplay();
    }, 10);
    await window.api.logActivity('Stopwatch started', 'timer');
  }
}

function pauseStopwatch() {
  if (isStopwatchRunning) {
    isStopwatchRunning = false;
    clearInterval(stopwatchInterval);
    await window.api.logActivity('Stopwatch paused', 'timer');
  }
}

function resetStopwatch() {
  isStopwatchRunning = false;
  clearInterval(stopwatchInterval);
  stopwatchTime = 0;
  updateStopwatchDisplay();
  await window.api.logActivity('Stopwatch reset', 'timer');
}

function updateStopwatchDisplay() {
  const totalCentiseconds = stopwatchTime;
  const hours = Math.floor(totalCentiseconds / 360000);
  const minutes = Math.floor((totalCentiseconds % 360000) / 6000);
  const seconds = Math.floor((totalCentiseconds % 6000) / 100);
  const centiseconds = totalCentiseconds % 100;
  
  document.getElementById('stopwatchDisplay').textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
}

function startTimer() {
  const hours = parseInt(document.getElementById('timerHours').value) || 0;
  const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
  const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
  
  timerTime = (hours * 3600) + (minutes * 60) + seconds;
  
  if (timerTime > 0 && !isTimerRunning) {
    isTimerRunning = true;
    timerInterval = setInterval(() => {
      timerTime--;
      updateTimerDisplay();
      
      if (timerTime <= 0) {
        pauseTimer();
        showNotification('Timer finished!');
        await window.api.logActivity('Timer completed', 'timer');
      }
    }, 1000);
    await window.api.logActivity('Timer started', 'timer');
  }
}

function pauseTimer() {
  isTimerRunning = false;
  clearInterval(timerInterval);
  await window.api.logActivity('Timer paused', 'timer');
}

function resetTimer() {
  isTimerRunning = false;
  clearInterval(timerInterval);
  timerTime = 0;
  updateTimerDisplay();
  await window.api.logActivity('Timer reset', 'timer');
}

function updateTimerDisplay() {
  const hours = Math.floor(timerTime / 3600);
  const minutes = Math.floor((timerTime % 3600) / 60);
  const seconds = timerTime % 60;
  
  document.getElementById('timerDisplay').textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

async function addReminder() {
  const text = document.getElementById('reminderText').value;
  const time = document.getElementById('reminderTime').value;
  
  if (!text || !time) {
      showError('Please fill in both reminder text and time.');
      return;
  }

  try {
      const reminderTime = new Date(time);
      const now = new Date();
      
      if (reminderTime <= now) {
          showError('Reminder time must be in the future.');
          return;
      }

      await window.api.addReminder(reminderTime.toISOString(), text);
      await updateRemindersDisplay(); // Refresh from backend
      showNotification(`Reminder set for ${reminderTime.toLocaleString()}`);
      await window.api.logActivity(`Reminder set: ${text}`, 'timer');

      document.getElementById('reminderText').value = '';
      document.getElementById('reminderTime').value = '';

      // Set local timeout for immediate notification, but backend is authoritative
      const timeout = reminderTime.getTime() - now.getTime();
      setTimeout(() => {
          showNotification(`Reminder: ${text}`);
      }, timeout);

  } catch (error) {
      console.error('Error adding reminder:', error);
      showError(`Failed to add reminder: ${error.message}`);
      await window.api.logError(`Frontend: Failed to add reminder: ${error.message}`, 'timer', error.stack);
  }
}

async function updateRemindersDisplay() {
    const container = document.getElementById('remindersList');
    if (!container) return;
    container.innerHTML = '';

    try {
        const reminders = await window.api.getReminders();
        reminders.sort((a, b) => new Date(a.reminder_time) - new Date(b.reminder_time)); // Sort by time

        reminders.forEach(reminder => {
            const reminderElement = document.createElement('div');
            reminderElement.className = 'p-2 bg-gray-700 rounded';
            reminderElement.innerHTML = `
                <div class="font-semibold">${reminder.text}</div>
                <div class="text-sm text-gray-400">${new Date(reminder.reminder_time).toLocaleString()}</div>
            `;
            container.appendChild(reminderElement);
        });
    } catch (error) {
        console.error('Error fetching reminders:', error);
        showError(`Failed to load reminders: ${error.message}`);
        await window.api.logError(`Frontend: Failed to fetch reminders: ${error.message}`, 'timer', error.stack);
    }
}


// Drawing tools
async function selectTool(button, tool) {
  document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => btn.classList.remove('active'));
  button.classList.add('active');
  currentTool = tool;
  
  const canvas = document.getElementById('drawingCanvas');
  canvas.style.cursor = tool === 'eraser' ? 'crosshair' : 'crosshair';
  
  await window.api.logActivity(`Drawing tool changed to: ${tool}`, 'notes');
}

async function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // Also clear saved drawing data in backend
  try {
      await window.api.saveNotes(document.getElementById('textNotes').value, ''); // Clear drawing data
      showNotification('Canvas cleared and saved.');
      await window.api.logActivity('Canvas cleared', 'notes');
  } catch (error) {
      console.error('Error clearing canvas data in backend:', error);
      showError(`Failed to clear canvas: ${error.message}`);
      await window.api.logError(`Frontend: Failed to clear canvas data: ${error.message}`, 'notes', error.stack);
  }
}

async function saveCanvas() {
    // Optionally trigger a download
    const link = document.createElement('a');
    link.download = `drawing_${Date.now()}.png`;
    link.href = canvas.toDataURL();
    link.click();

    // Also save drawing data to backend
    try {
        await window.api.saveNotes(document.getElementById('textNotes').value, canvas.toDataURL());
        showNotification('Drawing saved successfully!');
        await window.api.logActivity('Drawing saved', 'notes');
    } catch (error) {
        console.error('Error saving drawing to backend:', error);
        showError(`Failed to save drawing: ${error.message}`);
        await window.api.logError(`Frontend: Failed to save drawing: ${error.message}`, 'notes', error.stack);
    }
}

async function updateNotesDisplay(initialNotes = null) {
    const textNotesElem = document.getElementById('textNotes');
    const drawingCanvasElem = document.getElementById('drawingCanvas');

    let notesData = initialNotes;
    if (!notesData && currentSessionUser) { // If not initial load, fetch fresh data
        try {
            notesData = await window.api.getNotes();
        } catch (error) {
            console.error('Error fetching notes:', error);
            showError(`Failed to load notes: ${error.message}`);
            return;
        }
    }
    
    if (notesData) {
        textNotesElem.value = notesData.text_content || '';
        if (notesData.drawing_data && drawingCanvasElem) {
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, drawingCanvasElem.width, drawingCanvasElem.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = notesData.drawing_data;
        } else {
            ctx.clearRect(0, 0, drawingCanvasElem.width, drawingCanvasElem.height); // Clear if no data
        }
    }
}


// Calculator functions (client-side only for now)
function appendToCalc(value) {
  const display = document.getElementById('calcDisplay');
  if (display.textContent === '0' && value !== '.') { 
    display.textContent = value;
  } else {
    display.textContent += value;
  }
}

function clearCalc() {
  document.getElementById('calcDisplay').textContent = '0';
}

function deleteLast() {
  const display = document.getElementById('calcDisplay');
  if (display.textContent.length > 1) {
    display.textContent = display.textContent.slice(0, -1);
  } else {
    display.textContent = '0';
  }
}

async function calculateResult() {
  const display = document.getElementById('calcDisplay');
  try {
    const result = eval(display.textContent.replace('×', '*').replace('÷', '/')); 
    display.textContent = result;
    await window.api.logActivity(`Calculation performed: ${display.textContent} = ${result}`, 'calculator');
  } catch (error) {
    display.textContent = 'Error';
    await window.api.logError(`Frontend: Calculator error: ${error.message}, Expression: ${display.textContent}`, 'calculator', error.stack);
  }
}

// Unit converter (client-side only for now)
async function updateConversionUnits() {
  const type = document.getElementById('conversionType').value;
  const fromUnit = document.getElementById('fromUnit');
  const toUnit = document.getElementById('toUnit');
  
  const units = {
    length: [
      { value: 'm', text: 'Meters' }, { value: 'km', text: 'Kilometers' }, { value: 'cm', text: 'Centimeters' }, { value: 'mm', text: 'Millimeters' }, { value: 'in', text: 'Inches' }, { value: 'ft', text: 'Feet' }
    ],
    weight: [
      { value: 'kg', text: 'Kilograms' }, { value: 'g', text: 'Grams' }, { value: 'lb', text: 'Pounds' }, { value: 'oz', text: 'Ounces' }
    ],
    temperature: [
      { value: 'c', text: 'Celsius' }, { value: 'f', text: 'Fahrenheit' }, { value: 'k', text: 'Kelvin' }
    ],
    volume: [
        { value: 'l', text: 'Liters' }, { value: 'ml', text: 'Milliliters' }, { value: 'gal', text: 'Gallons' }, { value: 'qt', text: 'Quarts' }
    ]
  };
  
  fromUnit.innerHTML = '';
  toUnit.innerHTML = '';
  
  units[type].forEach(unit => {
    fromUnit.innerHTML += `<option value="${unit.value}">${unit.text}</option>`;
    toUnit.innerHTML += `<option value="${unit.value}">${unit.text}</option>`;
  });
  convertUnits(); 
  await window.api.logActivity(`Conversion type changed to: ${type}`, 'converter');
}

async function convertUnits() {
  const fromValue = parseFloat(document.getElementById('fromValue').value);
  const fromUnit = document.getElementById('fromUnit').value;
  const toUnit = document.getElementById('toUnit').value;
  const type = document.getElementById('conversionType').value;
  
  if (isNaN(fromValue)) {
    document.getElementById('toValue').value = '';
    return;
  }
  
  let result = fromValue;
  
  const factors = {
    length: { 
      'm': 1, 'km': 1000, 'cm': 0.01, 'mm': 0.001, 'in': 0.0254, 'ft': 0.3048
    },
    weight: { 
      'kg': 1000, 'g': 1, 'lb': 453.592, 'oz': 28.3495
    },
    temperature: { 
    }, // Handled separately
    volume: { 
        'l': 1, 'ml': 0.001, 'gal': 3.78541, 'qt': 0.946353
    }
  };
  
  if (type === 'length') {
    result = fromValue * factors.length[fromUnit] / factors.length[toUnit];
  } else if (type === 'weight') {
    result = fromValue * factors.weight[fromUnit] / factors.weight[toUnit];
  } else if (type === 'volume') {
    result = fromValue * factors.volume[fromUnit] / factors.volume[toUnit];
  } else if (type === 'temperature') {
      let tempInC;
      if (fromUnit === 'c') tempInC = fromValue;
      else if (fromUnit === 'f') tempInC = (fromValue - 32) * 5/9;
      else if (fromUnit === 'k') tempInC = fromValue - 273.15;

      if (toUnit === 'c') result = tempInC;
      else if (toUnit === 'f') result = (tempInC * 9/5) + 32;
      else if (toUnit === 'k') result = tempInC + 273.15;
  }
  
  document.getElementById('toValue').value = result.toFixed(6);
  await window.api.logActivity(`Unit converted: ${fromValue} ${fromUnit} to ${result.toFixed(6)} ${toUnit}`, 'converter');
}

// Media Player (client-side only for now)
async function loadMedia() {
    const mediaUrlInput = document.getElementById('mediaUrl');
    const mediaFrame = document.getElementById('mediaFrame');
    const url = mediaUrlInput.value;

    if (url) {
        // Basic YouTube URL parsing (very simplistic, might need more robust regex)
        let embedUrl = '';
        if (url.includes('youtube.com/watch?v=')) {
            const videoId = url.split('v=')[1].split('&')[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
        } else if (url.includes('youtu.be/')) {
            const videoId = url.split('youtu.be/')[1].split('?')[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
        } else {
            showError('Please enter a valid YouTube URL.');
            return;
        }
        mediaFrame.src = embedUrl;
        await window.api.logActivity(`Media loaded: ${embedUrl}`, 'media_player');
    }
}


// Theme functions
async function toggleTheme() {
    const newDarkModeStatus = document.body.classList.contains('light-theme'); // If light-theme is active, switching means dark mode will be false (or light true)
    
    document.body.classList.toggle('light-theme');
    isLightMode = document.body.classList.contains('light-theme');
    await window.api.logActivity('Theme toggled to ' + (isLightMode ? 'Light Mode' : 'Dark Mode'), 'settings');
    await updateStatsChartTheme();

    // Update backend settings
    if (currentSessionUser) {
        const updatedSettings = { ...currentSessionUser.settings, darkMode: !newDarkModeStatus };
        try {
            const response = await window.api.updateUserSettings(updatedSettings);
            currentSessionUser.settings = response.settings; // Update local user object
        } catch (error) {
            console.error('Error updating theme setting in backend:', error);
            await window.api.logError(`Frontend: Failed to update theme setting: ${error.message}`, 'settings', error.stack);
        }
    }
}

async function applyAccentTheme(theme, event) {
  const root = document.documentElement;
  
  const themes = {
    orange: { primary: '#ff4500', secondary: '#ff6b35' },
    blue: { primary: '#0066cc', secondary: '#004499' },
    green: { primary: '#00cc44', secondary: '#009933' },
    red: { primary: '#cc0044', secondary: '#990033' },
    purple: { primary: '#8800cc', secondary: '#6600aa' },
    amber: { primary: '#ffaa00', secondary: '#ff8800' },
    teal: { primary: '#00aaaa', secondary: '#008888' },
    pink: { primary: '#ff0088', secondary: '#cc0066' }
  };
  
  if (themes[theme]) {
    root.style.setProperty('--accent-color', themes[theme].primary);
    root.style.setProperty('--accent-secondary', themes[theme].secondary);
    
    if (document.body.classList.contains('light-theme')) {
        root.style.setProperty('--success-color', themes[theme].primary); 
        root.style.setProperty('--error-color', themes[theme].primary);   
        root.style.setProperty('--warning-color', themes[theme].primary); 
    } else {
        // Reset to original dark theme colors if not in light mode for consistency
        root.style.setProperty('--success-color', '#00ff41'); 
        root.style.setProperty('--error-color', '#ff0040');   
        root.style.setProperty('--warning-color', '#ffaa00');
    }

    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
    // If an event is passed, mark that specific element active, otherwise find by theme.
    if (event && event.target) {
        event.target.classList.add('active'); 
    } else {
        const matchingThemeOption = document.querySelector(`.theme-option[onclick*="applyAccentTheme('${theme}')"]`);
        if (matchingThemeOption) matchingThemeOption.classList.add('active');
    }
    
    await window.api.logActivity(`Accent theme changed to: ${theme}`, 'settings');
    await updateStatsChartTheme(); 

    // Update backend settings
    if (currentSessionUser) {
        const updatedSettings = { ...currentSessionUser.settings, accentTheme: theme };
        try {
            const response = await window.api.updateUserSettings(updatedSettings);
            currentSessionUser.settings = response.settings; // Update local user object
        } catch (error) {
            console.error('Error updating accent theme setting in backend:', error);
            await window.api.logError(`Frontend: Failed to update accent theme: ${error.message}`, 'settings', error.stack);
        }
    }
  }
}

function updateStatsChartTheme() {
    const chart = Chart.getChart('statsChart');
    if (chart) {
        chart.options.plugins.legend.labels.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
        chart.update();
    }
}


async function toggleSetting(toggle) {
  const settingKey = toggle.dataset.setting;
  const newValue = !toggle.classList.contains('active'); // Toggling means it's the opposite of current state
  toggle.classList.toggle('active', newValue); // Apply new state

  if (currentSessionUser) {
      const updatedSettings = { ...currentSessionUser.settings, [settingKey]: newValue };
      try {
          const response = await window.api.updateUserSettings(updatedSettings);
          currentSessionUser.settings = response.settings; // Update local user object
          await window.api.logActivity(`Setting toggled: ${settingKey} to ${newValue}`, 'settings');
      } catch (error) {
          console.error('Error updating setting:', error);
          showError(`Failed to update setting: ${error.message}`);
          await window.api.logError(`Frontend: Failed to update setting ${settingKey}: ${error.message}`, 'settings', error.stack);
          // Revert UI if API fails
          toggle.classList.toggle('active', !newValue);
      }
  }
  await updateStats(); // Update stats in UI and backend
}

// Refresh functions
async function refreshFact() {
  try {
      const globalData = await window.api.getGlobalData();
      const facts = globalData.random_facts || ["Failed to load facts."];
      document.getElementById('randomFact').textContent = facts[Math.floor(Math.random() * facts.length)];
      await window.api.logActivity('Random fact refreshed', 'content_refresh');
  } catch (error) {
      console.error('Error refreshing fact:', error);
      showError(`Failed to refresh fact: ${error.message}`);
      document.getElementById('randomFact').textContent = "Failed to load fact.";
      await window.api.logError(`Frontend: Failed to refresh fact: ${error.message}`, 'content_refresh', error.stack);
  }
}

async function refreshQuote() {
  try {
      const globalData = await window.api.getGlobalData();
      const quotes = globalData.daily_quotes || [{quote: "Failed to load quote.", author: "System"}];
      const quote = quotes[Math.floor(Math.random() * quotes.length)];
      document.getElementById('dailyQuote').textContent = `"${quote.quote || 'No quote available.'}" - ${quote.author || 'Unknown'}`;
      await window.api.logActivity('Daily quote refreshed', 'content_refresh');
  } catch (error) {
      console.error('Error refreshing quote:', error);
      showError(`Failed to refresh quote: ${error.message}`);
      document.getElementById('dailyQuote').textContent = "Failed to load quote.";
      await window.api.logError(`Frontend: Failed to refresh quote: ${error.message}`, 'content_refresh', error.stack);
  }
}

function clearNotifications() {
  document.getElementById('notificationsList').innerHTML = '';
  await window.api.logActivity('Notifications cleared (client-side)', 'ui_interaction');
}

async function clearActivityLogs() {
  if (confirm("Are you sure you want to clear all activity logs?")) {
    try {
        await window.api.clearActivityLogs();
        await updateActivityLogDisplay([]); // Clear UI immediately
        showNotification("Activity logs cleared.");
        await window.api.logActivity('Activity logs cleared', 'logs_control');
    } catch (error) {
        console.error('Error clearing activity logs:', error);
        showError(`Failed to clear activity logs: ${error.message}`);
        await window.api.logError(`Frontend: Failed to clear activity logs: ${error.message}`, 'logs_control', error.stack);
    }
  }
}

async function saveTextNotes() {
  const textNotes = document.getElementById('textNotes').value;
  const drawingData = canvas ? canvas.toDataURL() : ''; // Get current canvas state
  try {
      await window.api.saveNotes(textNotes, drawingData);
      showNotification('Notes saved successfully!');
      await window.api.logActivity('Text notes saved', 'notes');
  } catch (error) {
      console.error('Error saving notes:', error);
      showError(`Failed to save notes: ${error.message}`);
      await window.api.logError(`Frontend: Failed to save notes: ${error.message}`, 'notes', error.stack);
  }
}

async function clearTextNotes() {
  if (confirm("Are you sure you want to clear your text notes?")) {
    document.getElementById('textNotes').value = '';
    // Clear in backend
    try {
        await window.api.saveNotes('', canvas ? canvas.toDataURL() : ''); // Clear text content
        showNotification('Text notes cleared.');
        await window.api.logActivity('Text notes cleared', 'notes');
    } catch (error) {
        console.error('Error clearing text notes in backend:', error);
        showError(`Failed to clear text notes: ${error.message}`);
        await window.api.logError(`Frontend: Failed to clear text notes: ${error.message}`, 'notes', error.stack);
    }
  }
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = 'notification';
  let icon = '<i class="fas fa-info-circle"></i>';
  if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
  if (type === 'error') icon = '<i class="fas fa-times-circle"></i>';
  if (type === 'warning') icon = '<i class="fas fa-exclamation-triangle"></i>';

  notification.innerHTML = `${icon} ${message}`;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

async function logout() {
  if (confirm('Are you sure you want to logout?')) {
    sessionStorage.removeItem('token'); // Clear JWT
    currentSessionUser = null; // Clear local user data
    await window.api.logActivity('User logged out', 'auth');
    location.reload(); // Reloads page, which will go back to login screen
  }
}

// New functions requested by user
async function takeScreenshot() {
    html2canvas(document.body).then(async function(canvas) {
        const link = document.createElement('a');
        link.download = `screenshot_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Screenshot saved!');
        await window.api.logActivity('Screenshot taken', 'ui_interaction');
        currentSessionUser.stats.buttonPresses++; // Update local stats
        await updateStats(); // Push to backend
    }).catch(async error => {
        console.error('Error taking screenshot:', error);
        showError(`Failed to take screenshot: ${error.message}`);
        await window.api.logError(`Frontend: Failed to take screenshot: ${error.message}`, 'ui_interaction', error.stack);
    });
}

async function togglePanelsGridVisibility() {
    const panelsGrid = document.getElementById('panelsGrid');
    if (panelsGrid.style.display === 'none' || panelsGrid.style.opacity === '0') {
        panelsGrid.style.display = 'grid';
        panelsGrid.style.opacity = '1';
        showNotification('Sections are now visible.');
        await window.api.logActivity('Sections toggled ON', 'ui_interaction');
    } else {
        panelsGrid.style.opacity = '0'; 
        setTimeout(() => {
            panelsGrid.style.display = 'none';
        }, 300);
        showNotification('Sections are now hidden.');
        await window.api.logActivity('Sections toggled OFF', 'ui_interaction');
    }
    currentSessionUser.stats.buttonPresses++; // Update local stats
    await updateStats(); // Push to backend
}

async function restartSystem() {
    if (confirm('Are you sure you want to restart the system? You will be logged out and all unsaved data will be lost.')) {
        sessionStorage.removeItem('token'); // Clear JWT
        currentSessionUser = null; // Clear local user data
        // For a full system restart, you'd trigger an API endpoint, which then might restart the backend service.
        // For now, client-side restart means clearing session and reloading.
        await window.api.logActivity('System restarted (client-side)', 'system_control');
        location.reload(); 
    }
}

// Helper functions for populating static content from global data
async function updateSystemUpdatesDisplay(updates) {
    const container = document.getElementById('systemUpdatesList');
    if (!container) return;
    container.innerHTML = '';
    if (!updates || updates.length === 0) {
        container.innerHTML = '<div class="system-update-item">No recent updates.</div>';
        return;
    }
    updates.forEach(update => {
        const item = document.createElement('div');
        item.className = 'system-update-item';
        item.textContent = update;
        container.appendChild(item);
    });
}

async function populateWifiInfo(wifiNetworks) {
    const container = document.getElementById('wifiInfoBoard');
    if (!container) return;
    container.innerHTML = '';
    if (!wifiNetworks || wifiNetworks.length === 0) {
        container.innerHTML = '<div class="text-popup-content"><p>No WiFi network information available.</p></div>';
        return;
    }
    wifiNetworks.forEach(network => {
        const card = document.createElement('div');
        card.className = 'wifi-network-card';
        card.innerHTML = `
            <h4>${network.name || 'Unknown Network'}</h4>
            <div><span>Network Name:</span> <span>${network.networkName || 'N/A'}</span></div>
            <div><span>Wifi Level:</span> <span>${network.level || 'N/A'}</span></div>
            <div><span>Wifi Security Type:</span> <span>${network.securityType || 'N/A'}</span></div>
            <div><span>Wifi Encryption Type:</span> <span>${network.encryptionType || 'N/A'}</span></div>
            <div><span>Hidden?:</span> <span>${network.hidden ? 'Yes' : 'No'}</span></div>
            <div><span>Monitored?:</span> <span>${network.monitored || 'Unknown'}</span></div>
            <div><span>Username:</span> <span>${network.username || 'Unknown'}</span></div>
            <div><span>Password:</span> <span>${network.password || 'Unknown'}</span></div>
        `;
        container.appendChild(card);
    });
}

async function populateLinks(elementId, links, wrapperTag = 'div') {
    const container = document.getElementById(elementId);
    if (!container) return;
    container.innerHTML = '';
    if (!links || links.length === 0) {
        container.innerHTML = `<${wrapperTag} class="text-secondary">No links available.</${wrapperTag}>`;
        return;
    }
    links.forEach(link => {
        if (link.url) { // Ensure URL exists
            const linkElement = document.createElement('a');
            linkElement.href = link.url;
            linkElement.target = "_blank";
            linkElement.className = 'quick-btn text-center flex-grow'; // Apply quick-btn styling
            linkElement.innerHTML = `<i class="fas fa-external-link-alt"></i> ${link.name || link.url}`;
            container.appendChild(linkElement);
        }
    });
}

async function populatePhoneDirectory(entries) {
    const container = document.getElementById('phoneDirectoryContent');
    if (!container) return;
    container.innerHTML = '<h3>Teacher Directory</h3>';
    if (!entries || entries.length === 0) {
        container.innerHTML += '<p>No directory entries available.</p>';
        return;
    }
    entries.forEach(entry => {
        container.innerHTML += `<p><strong>${entry.name || 'N/A'}:</strong> ${entry.phone || 'N/A'}${entry.room ? ` (Room: ${entry.room})` : ''}${entry.email ? ` (Email: ${entry.email})` : ''}</p>`;
    });
}

async function populateSchoolInfo(info) {
    const container = document.getElementById('schoolInfoContent');
    if (!container) return;
    if (!info || Object.keys(info).length === 0) {
        container.innerHTML = '<p>No school information available.</p>';
        return;
    }
    container.innerHTML = `
        <p><strong>School Name:</strong> ${info.name || 'N/A'}</p>
        <p><strong>School Address:</strong> ${info.address || 'N/A'}</p>
        <p><strong>School Phone:</strong> ${info.phone || 'N/A'}</p>
        <p><strong>School Fax:</strong> ${info.fax || 'N/A'}</p>
        <br>
        <p><strong>School Principal:</strong> ${info.principalName || 'N/A'}</p>
        <p><strong>Principal's Phone:</strong> ${info.principalPhone || 'N/A'}</p>
        <p><strong>Principal's Email:</strong> ${info.principalEmail || 'N/A'}</p>
        <br>
        <p><strong>Assistant Principal:</strong> ${info.assistantPrincipalName || 'N/A'}</p>
        <p><strong>Assistant Principal's Phone:</strong> ${info.assistantPrincipalPhone || 'N/A'}</p>
        <p><strong>Assistant Principal's Email:</strong> ${info.assistantPrincipalEmail || 'N/A'}</p>
    `;
}

async function populateBypassingTools(tools) {
    // This is more complex as it involves existing sub-panels.
    // Assuming 'tools' is an object like { bathroom: "text", wifi: "text" }
    // Update the content of existing hidden divs
    if (tools.bathroom) document.getElementById('bathroomBypassText').querySelector('p').textContent = tools.bathroom;
    if (tools.wifi) document.getElementById('wifiBypassText').querySelector('p').textContent = tools.wifi;
    if (tools.teacherMonitoring) document.getElementById('teacherMonitoringBypassText').querySelector('p').textContent = tools.teacherMonitoring;
    // Add other coming soon as needed
}

async function populateKeyboardTricks(categories) {
    const container = document.getElementById('keyboardTricksContent');
    if (!container) return;
    container.innerHTML = '';
    if (!categories || categories.length === 0) {
        container.innerHTML = '<p>No keyboard tricks available.</p>';
        return;
    }
    categories.forEach(cat => {
        container.innerHTML += `<h3>${cat.category}</h3>`;
        const ul = document.createElement('ul');
        cat.tricks.forEach(trick => {
            const li = document.createElement('li');
            li.textContent = trick;
            ul.appendChild(li);
        });
        container.appendChild(ul);
    });
}


// Event listeners
document.addEventListener('DOMContentLoaded', async () => {
  setupToggles(); // Setup toggles (some will be controlled by fetched settings)
  
  submitBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    if (currentSessionUser) currentSessionUser.stats.buttonPresses++;
    await attemptLogin();
  });

  resetBtn.addEventListener('click', resetCounter); 
  
  document.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') {
        if (resetPopup.style.display === 'flex') { // If reset popup is visible
            await resetCounter();
        } else if (!document.getElementById('loginScreen').classList.contains('hidden')) { // If login screen is visible
            await attemptLogin();
        }
    }
  });
  
  document.getElementById('penColor').addEventListener('change', async (e) => {
    currentColor = e.target.value;
    await window.api.logActivity(`Pen color changed to: ${currentColor}`, 'notes');
  });
  
  document.getElementById('penThickness').addEventListener('input', async (e) => {
    currentThickness = parseInt(e.target.value);
    await window.api.logActivity(`Pen thickness changed to: ${currentThickness}`, 'notes');
  });
  
  // No initial load of saved notes from localStorage, will be fetched from API
  // const savedNotes = localStorage.getItem('textNotes');
  // if (savedNotes) {
  //   document.getElementById('textNotes').value = savedNotes;
  // }
  
  document.addEventListener('click', async (e) => {
    // Only count clicks on specific interactive elements if a user is logged in
    if (currentSessionUser && ((e.target.tagName === 'BUTTON' && !e.target.closest('.panel-controls') && !e.target.classList.contains('submit-btn')) || e.target.closest('.quick-btn') || e.target.closest('.main-menu-btn'))) {
        currentSessionUser.stats.buttonPresses++;
        await updateStats(); // Update stats in UI and backend
    }
  });
  
  // Set default values for Important Dates inputs (current date and a default time)
  const today = new Date();
  document.getElementById('importantDateDay').value = today.toISOString().split('T')[0];
  document.getElementById('importantDateTime').value = "09:00"; 
});
</script>

</body>
</html>
